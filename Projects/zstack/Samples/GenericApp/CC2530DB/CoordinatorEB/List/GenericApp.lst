###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         18/Feb/2014  13:14:08 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\Source\GenericApp.c                 #
#    Command line       =  -f Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\S #
#                          amples\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wCoord.cfg (-DCPU32MHZ -DROOT=__near_func       #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8         #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\S #
#                          amples\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wConfig.cfg (-DZIGBEEPRO -DSECURE=0             #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00002000                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 Z:\Designs\ZigbeeTI\CODE\wo #
#                          rk\Projects\zstack\Samples\GenericApp\Source\Gener #
#                          icApp.c -D ZTOOL_P1 -D NV_INIT -D xNV_RESTORE -D   #
#                          ZIGBEE_FREQ_AGILITY -D PANID_DISPLAY -D            #
#                          ZIGBEE_PANID_CONFLICT -D NWK_MANAGER -D xMT_TASK   #
#                          -D xMT_SYS_FUNC -D xMT_ZDO_FUNC -lC                #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\CoordinatorEB\List\ -lA    #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\CoordinatorEB\List\        #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\CoordinatorEB\Obj\ -e      #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\S #
#                          amples\GenericApp\CC2530DB\ -I                     #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\Source\ -I              #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\ZMain\TI2530DB\   #
#                          -I Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\S #
#                          amples\GenericApp\CC2530DB\..\..\..\..\..\Componen #
#                          ts\hal\include\ -I Z:\Designs\ZigbeeTI\CODE\work\P #
#                          rojects\zstack\Samples\GenericApp\CC2530DB\..\..\. #
#                          .\..\..\Components\hal\target\CC2530EB\ -I         #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\include\ -I Z:\Designs\ZigbeeTI\CODE\work\Proj #
#                          ects\zstack\Samples\GenericApp\CC2530DB\..\..\..\. #
#                          .\..\Components\mac\high_level\ -I                 #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\low_level\srf04\ -I Z:\Designs\ZigbeeTI\CODE\w #
#                          ork\Projects\zstack\Samples\GenericApp\CC2530DB\.. #
#                          \..\..\..\..\Components\mac\low_level\srf04\single #
#                          _chip\ -I Z:\Designs\ZigbeeTI\CODE\work\Projects\z #
#                          stack\Samples\GenericApp\CC2530DB\..\..\..\..\..\C #
#                          omponents\mt\ -I Z:\Designs\ZigbeeTI\CODE\work\Pro #
#                          jects\zstack\Samples\GenericApp\CC2530DB\..\..\..\ #
#                          ..\..\Components\osal\include\ -I                  #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          services\saddr\ -I Z:\Designs\ZigbeeTI\CODE\work\P #
#                          rojects\zstack\Samples\GenericApp\CC2530DB\..\..\. #
#                          .\..\..\Components\services\sdata\ -I              #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\af\ -I Z:\Designs\ZigbeeTI\CODE\work\Project #
#                          s\zstack\Samples\GenericApp\CC2530DB\..\..\..\..\. #
#                          .\Components\stack\nwk\ -I                         #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sapi\ -I Z:\Designs\ZigbeeTI\CODE\work\Proje #
#                          cts\zstack\Samples\GenericApp\CC2530DB\..\..\..\.. #
#                          \..\Components\stack\sec\ -I                       #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sys\ -I Z:\Designs\ZigbeeTI\CODE\work\Projec #
#                          ts\zstack\Samples\GenericApp\CC2530DB\..\..\..\..\ #
#                          ..\Components\stack\zdo\ -I                        #
#                          Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\..\..\..\..\..\Components\ #
#                          zmac\ -I Z:\Designs\ZigbeeTI\CODE\work\Projects\zs #
#                          tack\Samples\GenericApp\CC2530DB\..\..\..\..\..\Co #
#                          mponents\zmac\f8w\ -Ohz --require_prototypes       #
#    List file          =  Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\CoordinatorEB\List\Generic #
#                          App.lst                                            #
#    Object file        =  Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samp #
#                          les\GenericApp\CC2530DB\CoordinatorEB\Obj\GenericA #
#                          pp.r51                                             #
#                                                                             #
#                                                                             #
###############################################################################

Z:\Designs\ZigbeeTI\CODE\work\Projects\zstack\Samples\GenericApp\Source\GenericApp.c
      1          /******************************************************************************
      2            Filename:       GenericApp.c
      3            Revised:        $Date: 2012-03-07 01:04:58 -0800 (Wed, 07 Mar 2012) $
      4            Revision:       $Revision: 29656 $
      5          
      6            Description:    Generic Application (no Profile).
      7          
      8          
      9            Copyright 2004-2012 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License"). You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product. Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          ******************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends "Hello World" to another "Generic"
     45            application every 5 seconds.  The application will also
     46            receives "Hello World" packets.
     47          
     48            The "Hello World" messages are sent/received as MSG type message.
     49          
     50            This applications doesn't have a profile, so it handles everything
     51            directly - itself.
     52          
     53            Key control:
     54              SW1:
     55              SW2:  initiates end device binding
     56              SW3:
     57              SW4:  initiates a match description request
     58          *********************************************************************/
     59          
     60          /*********************************************************************
     61           * INCLUDES
     62           */
     63          #include "OSAL.h"
     64          #include "AF.h"
     65          #include "ZDApp.h"
     66          #include "ZDObject.h"
     67          #include "ZDProfile.h"
     68          
     69          #include "GenericApp.h"
     70          #include "DebugTrace.h"
     71          
     72          #if !defined( WIN32 )
     73            #include "OnBoard.h"

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1
     74          #endif
     75          
     76          /* HAL */
     77          #include "hal_lcd.h"
     78          #include "hal_led.h"
     79          #include "hal_key.h"
     80          #include "hal_uart.h"
     81          #include "MT_UART.h"
     82          
     83          #if defined ( MODBUS_SUPPLY)
     84            #include "modbus.h"
     85          #endif
     86          /*********************************************************************
     87           * MACROS
     88           */
     89          
     90          /*********************************************************************
     91           * CONSTANTS
     92           */
     93          
     94          /*********************************************************************
     95           * TYPEDEFS
     96           */
     97          #if defined ( START_ROUTER)
     98            // signal strength list
     99            typedef struct signalStrength
    100            {
    101              struct signalStrength *next;
    102              uint8 modbus_id;
    103              int8 rssi;
    104            } signalStrength_t;
    105          #endif
    106          
    107          /*********************************************************************
    108           * GLOBAL VARIABLES
    109           */
    110          // This list should be filled with Application specific Cluster IDs.

   \                                 In  segment XDATA_ROM_C, align 1
    111          const cId_t GenericApp_ClusterList[GENERICAPP_MAX_CLUSTERS] =
   \                     GenericApp_ClusterList:
   \   000000   0200         DW 2
    112          {
    113            GENERICAPP_CLUSTERID
    114          };
    115          

   \                                 In  segment XDATA_ROM_C, align 1
    116          const SimpleDescriptionFormat_t GenericApp_SimpleDesc =
   \                     GenericApp_SimpleDesc:
   \   000000   02           DB 2
   \   000001   100F         DW 3856
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   01           DB 1
   \   000007   ....         DW GenericApp_ClusterList
   \   000009   01           DB 1
   \   00000A   ....         DW GenericApp_ClusterList
    117          {
    118            GENERICAPP_ENDPOINT,              //  int Endpoint;
    119            GENERICAPP_PROFID,                //  uint16 AppProfId[2];
    120            GENERICAPP_DEVICEID,              //  uint16 AppDeviceId[2];
    121            GENERICAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
    122            GENERICAPP_FLAGS,                 //  int   AppFlags:4;
    123            GENERICAPP_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    124            (cId_t *)GenericApp_ClusterList,  //  byte *pAppInClusterList;
    125            GENERICAPP_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    126            (cId_t *)GenericApp_ClusterList   //  byte *pAppInClusterList;
    127          };
    128          
    129          // This is the Endpoint/Interface description.  It is defined here, but
    130          // filled-in in GenericApp_Init().  Another way to go would be to fill
    131          // in the structure here and make it a "const" (in code space).  The
    132          // way it's defined in this sample app it is define in RAM.

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    133          endPointDesc_t GenericApp_epDesc;
   \                     GenericApp_epDesc:
   \   000000                DS 6
   \   000006                REQUIRE __INIT_XDATA_Z
    134          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    135          Tx_data_t TxBuffer;
   \                     TxBuffer:
   \   000000                DS 514
   \   000202                REQUIRE __INIT_XDATA_Z
    136          
    137          #if defined (START_ROUTER)
    138            uint8 reg_len;
    139            uint8 len_check_flag = 0;
    140            bool ack_exist = TRUE;
    141            // check tstat modbus id
    142            uint8 ask_modbus_id[8] = { 0xff, 0x03, 0x00, 0x06, 0x00, 0x01, 0x71, 0xd5};
    143            uint8 tstat_id = 0;
    144            signalStrength_t *pSignalStren;
    145            uint8 numSignalStren = 0;
    146          #else
    147            #ifdef PANID_DISPLAY

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    148              bool panId_send = FALSE;
   \                     panId_send:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    149              uint8 panId_send_hi, panId_send_lo;
   \                     panId_send_hi:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
   \                     panId_send_lo:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    150              uint8 rssi_send_hi, rssi_send_lo;
   \                     rssi_send_hi:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
   \                     rssi_send_lo:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    151              uint8 rev_hi, rev_lo;
   \                     rev_hi:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
   \                     rev_lo:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    152              #define TEMCO_ZIGBEE_REV  9
    153            #endif

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    154            uint16 update_addr;
   \                     update_addr:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    155            
    156          #endif
    157          /*********************************************************************
    158           * EXTERNAL VARIABLES
    159           */
    160          
    161          /*********************************************************************
    162           * EXTERNAL FUNCTIONS
    163           */
    164          
    165          /*********************************************************************
    166           * LOCAL VARIABLES
    167           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    168          byte GenericApp_TaskID;   // Task ID for internal task/event processing
   \                     GenericApp_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    169                                    // This variable will be received when
    170                                    // GenericApp_Init() is called.

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    171          devStates_t GenericApp_NwkState;
   \                     GenericApp_NwkState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    172          
    173          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    174          byte GenericApp_TransID;  // This is the unique message ID (counter)
   \                     GenericApp_TransID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    175          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    176          afAddrType_t GenericApp_DstAddr;
   \                     GenericApp_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z
    177          
    178          /*********************************************************************
    179           * LOCAL FUNCTIONS
    180           */
    181          static void GenericApp_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg );
    182          static void GenericApp_MessageMSGCB( afIncomingMSGPacket_t *pckt );
    183          
    184          afStatus_t zb_SendDataRequest( uint16 destination, uint16 commandId, uint8 len,
    185                                    uint8 *pData, uint8 handle, uint8 txOptions, uint8 radius );
    186          
    187          void InitCRC16(void);
    188          void CRC16_Tstat(unsigned char ch);
    189          void calcCRC16( uint8* data, uint8 len);
    190          
    191          #if defined (START_ROUTER)
    192            static Status_t register_signalStrength( uint8 modbus_id, int8 rssi);
    193            static signalStrength_t *findSignalStrength( uint8 modbus_id);
    194            static void sendAllSignalStren( void);
    195          #endif
    196          /*********************************************************************
    197           * NETWORK LAYER CALLBACKS
    198           */
    199          
    200          /*********************************************************************
    201           * PUBLIC FUNCTIONS
    202           */
    203          
    204          /*********************************************************************
    205           * @fn      GenericApp_Init
    206           *
    207           * @brief   Initialization function for the Generic App Task.
    208           *          This is called during initialization and should contain
    209           *          any application specific initialization (ie. hardware
    210           *          initialization/setup, table initialization, power up
    211           *          notificaiton ... ).
    212           *
    213           * @param   task_id - the ID assigned by OSAL.  This ID should be
    214           *                    used to send messages and set timers.
    215           *
    216           * @return  none
    217           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    218          void GenericApp_Init( uint8 task_id )
   \                     GenericApp_Init:
    219          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    220            MT_UartInit();
   \   000007                ; Setup parameters for call to function MT_UartInit
   \   000007   12....       LCALL   ??MT_UartInit?relay
    221            GenericApp_TaskID = task_id;
   \   00000A   EE           MOV     A,R6
   \   00000B   90....       MOV     DPTR,#GenericApp_TaskID
   \   00000E   F0           MOVX    @DPTR,A
    222            GenericApp_NwkState = DEV_INIT;
   \   00000F   90....       MOV     DPTR,#GenericApp_NwkState
   \   000012   7401         MOV     A,#0x1
   \   000014   F0           MOVX    @DPTR,A
    223            GenericApp_TransID = 0;
   \   000015   90....       MOV     DPTR,#GenericApp_TransID
   \   000018   E4           CLR     A
   \   000019   F0           MOVX    @DPTR,A
    224          
    225            // Device hardware initialization can be added here or in main() (Zmain.c).
    226            // If the hardware is application specific - add it here.
    227            // If the hardware is other parts of the device add it in main().
    228          
    229            GenericApp_DstAddr.addrMode = (afAddrMode_t)AddrNotPresent;
   \   00001A   90....       MOV     DPTR,#GenericApp_DstAddr + 8
   \   00001D   F0           MOVX    @DPTR,A
    230            GenericApp_DstAddr.endPoint = 0;
   \   00001E   A3           INC     DPTR
   \   00001F   F0           MOVX    @DPTR,A
    231            GenericApp_DstAddr.addr.shortAddr = 0;
   \   000020   90....       MOV     DPTR,#GenericApp_DstAddr
   \   000023   F0           MOVX    @DPTR,A
   \   000024   A3           INC     DPTR
   \   000025   F0           MOVX    @DPTR,A
    232          
    233            // Fill out the endpoint description.
    234            GenericApp_epDesc.endPoint = GENERICAPP_ENDPOINT;
   \   000026   90....       MOV     DPTR,#GenericApp_epDesc
   \   000029   7402         MOV     A,#0x2
   \   00002B   F0           MOVX    @DPTR,A
    235            GenericApp_epDesc.task_id = &GenericApp_TaskID;
   \   00002C   A3           INC     DPTR
   \   00002D   74..         MOV     A,#GenericApp_TaskID & 0xff
   \   00002F   F0           MOVX    @DPTR,A
   \   000030   A3           INC     DPTR
   \   000031   74..         MOV     A,#(GenericApp_TaskID >> 8) & 0xff
   \   000033   F0           MOVX    @DPTR,A
    236            GenericApp_epDesc.simpleDesc
    237                      = (SimpleDescriptionFormat_t *)&GenericApp_SimpleDesc;
   \   000034   A3           INC     DPTR
   \   000035   74..         MOV     A,#GenericApp_SimpleDesc & 0xff
   \   000037   F0           MOVX    @DPTR,A
   \   000038   A3           INC     DPTR
   \   000039   74..         MOV     A,#(GenericApp_SimpleDesc >> 8) & 0xff
   \   00003B   F0           MOVX    @DPTR,A
    238            GenericApp_epDesc.latencyReq = noLatencyReqs;
   \   00003C   A3           INC     DPTR
   \   00003D   E4           CLR     A
   \   00003E   F0           MOVX    @DPTR,A
    239          
    240            // Register the endpoint description with the AF
    241            afRegister( &GenericApp_epDesc );
   \   00003F                ; Setup parameters for call to function afRegister
   \   00003F   7A..         MOV     R2,#GenericApp_epDesc & 0xff
   \   000041   7B..         MOV     R3,#(GenericApp_epDesc >> 8) & 0xff
   \   000043   12....       LCALL   ??afRegister?relay
    242          
    243            // Register for all key events - This app will handle all key events
    244            RegisterForKeys( GenericApp_TaskID );
   \   000046                ; Setup parameters for call to function RegisterForKeys
   \   000046   90....       MOV     DPTR,#GenericApp_TaskID
   \   000049   E0           MOVX    A,@DPTR
   \   00004A   F9           MOV     R1,A
   \   00004B   12....       LCALL   ??RegisterForKeys?relay
    245          
    246            // Update the display
    247          #if defined ( LCD_SUPPORTED )
    248            HalLcdWriteString( "GenericApp", HAL_LCD_LINE_1 );
    249          #endif
    250          
    251            ZDO_RegisterForZDOMsg( GenericApp_TaskID, End_Device_Bind_rsp );
   \   00004E                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   00004E   7A20         MOV     R2,#0x20
   \   000050   7B80         MOV     R3,#-0x80
   \   000052   90....       MOV     DPTR,#GenericApp_TaskID
   \   000055   E0           MOVX    A,@DPTR
   \   000056   F9           MOV     R1,A
   \   000057   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    252            ZDO_RegisterForZDOMsg( GenericApp_TaskID, Match_Desc_rsp );
   \   00005A                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   00005A   7A06         MOV     R2,#0x6
   \   00005C   7B80         MOV     R3,#-0x80
   \   00005E   90....       MOV     DPTR,#GenericApp_TaskID
   \   000061   E0           MOVX    A,@DPTR
   \   000062   F9           MOV     R1,A
   \   000063   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    253          
    254          #if defined START_ROUTER
    255            //P0SEL &= ~BV(6);
    256            //P0DIR |= BV(6);
    257            //P0_6 = 1;
    258            pSignalStren = (signalStrength_t*)NULL;
    259          #else
    260            HAL_TURN_ON_LED1();
   \   000066   C290         CLR     0x90.0
    261            osal_set_event(GenericApp_TaskID, TX_MSG_EVENT);    // 用轮询的方法，发送串口消息
   \   000068                ; Setup parameters for call to function osal_set_event
   \   000068   7A04         MOV     R2,#0x4
   \   00006A   7B00         MOV     R3,#0x0
   \   00006C   90....       MOV     DPTR,#GenericApp_TaskID
   \   00006F   E0           MOVX    A,@DPTR
   \   000070   F9           MOV     R1,A
   \   000071   12....       LCALL   ??osal_set_event?relay
    262          #endif
    263          }
   \   000074   7F01         MOV     R7,#0x1
   \   000076   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000079                REQUIRE _A_P1
    264          
    265          /*********************************************************************
    266           * @fn      GenericApp_ProcessEvent
    267           *
    268           * @brief   Generic Application Task event processor.  This function
    269           *          is called to process all events for the task.  Events
    270           *          include timers, messages and any other user defined events.
    271           *
    272           * @param   task_id  - The OSAL assigned task ID.
    273           * @param   events - events to process.  This is a bit map and can
    274           *                   contain more than one event.
    275           *
    276           * @return  none
    277           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    278          uint16 GenericApp_ProcessEvent( uint8 task_id, uint16 events )
   \                     GenericApp_ProcessEvent:
    279          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV     A,#-0x1
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 0,R2
   \   00000C   8B..         MOV     ?V0 + 1,R3
    280            afIncomingMSGPacket_t *MSGpkt;
    281            afDataConfirm_t *afDataConfirm;
    282          
    283            // Data Confirmation message fields
    284            byte sentEP;
    285            ZStatus_t sentStatus;
    286            byte sentTransID;       // This should match the value sent
    287            (void)task_id;  // Intentionally unreferenced parameter
    288          
    289            if ( events & SYS_EVENT_MSG )
   \   00000E   EB           MOV     A,R3
   \   00000F   5480         ANL     A,#0x80
   \   000011   7003         JNZ     $+5
   \   000013   02....       LJMP    ??GenericApp_ProcessEvent_0 & 0xFFFF
    290            {
    291              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( GenericApp_TaskID );
   \   000016                ; Setup parameters for call to function osal_msg_receive
   \   000016   800D         SJMP    ??GenericApp_ProcessEvent_1
    292              while ( MSGpkt )
    293              {
    294                switch ( MSGpkt->hdr.event )
    295                {
    296                  case ZDO_CB_MSG:
    297                    GenericApp_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt );
    298                    break;
    299          
    300                  case AF_DATA_CONFIRM_CMD:
    301                    // This message is received as a confirmation of a data packet sent.
    302                    // The status is of ZStatus_t type [defined in ZComDef.h]
    303                    // The message fields are defined in AF.h
    304                    afDataConfirm = (afDataConfirm_t *)MSGpkt;
    305                    sentEP = afDataConfirm->endpoint;
    306                    sentStatus = afDataConfirm->hdr.status;
    307                    sentTransID = afDataConfirm->transID;
    308                    (void)sentEP;
    309                    (void)sentTransID;
    310          
    311                    // Action taken when confirmation is received.
    312                    if ( sentStatus != ZSuccess )
    313                    {
    314                      // The data wasn't delivered -- Do something
    315                    }
    316                    break;
    317          
    318                  case AF_INCOMING_MSG_CMD:
    319                    GenericApp_MessageMSGCB( MSGpkt );
    320                    break;
    321          
    322                  case ZDO_STATE_CHANGE:
    323                    GenericApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
   \                     ??GenericApp_ProcessEvent_2:
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   90....       MOV     DPTR,#GenericApp_NwkState
   \   00001D   F0           MOVX    @DPTR,A
    324                    if ( (GenericApp_NwkState == DEV_ZB_COORD)
    325                        || (GenericApp_NwkState == DEV_ROUTER)
    326                        || (GenericApp_NwkState == DEV_END_DEVICE) )
    327                    {
    328          #if defined (START_ROUTER)
    329                      osal_set_event( GenericApp_TaskID, ACK_CHECK);
    330                      osal_set_event( GenericApp_TaskID, ASK_MODBUS_ID);
    331          #endif
    332                    }
    333                    break;
    334          
    335                  default:
    336                    break;
    337                }
    338          
    339                // Release the memory
    340                osal_msg_deallocate( (uint8 *)MSGpkt );
   \                     ??GenericApp_ProcessEvent_3:
   \   00001E                ; Setup parameters for call to function osal_msg_deallocate
   \   00001E   EE           MOV     A,R6
   \   00001F   FA           MOV     R2,A
   \   000020   EF           MOV     A,R7
   \   000021   FB           MOV     R3,A
   \   000022   12....       LCALL   ??osal_msg_deallocate?relay
    341          
    342                // Next
    343                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( GenericApp_TaskID );
   \   000025                ; Setup parameters for call to function osal_msg_receive
   \                     ??GenericApp_ProcessEvent_1:
   \   000025   90....       MOV     DPTR,#GenericApp_TaskID
   \   000028   E0           MOVX    A,@DPTR
   \   000029   F9           MOV     R1,A
   \   00002A   12....       LCALL   ??osal_msg_receive?relay
   \   00002D   8A..         MOV     ?V0 + 2,R2
   \   00002F   8B..         MOV     ?V0 + 3,R3
   \   000031   AE..         MOV     R6,?V0 + 2
   \   000033   AF..         MOV     R7,?V0 + 3
   \   000035   EE           MOV     A,R6
   \   000036   4F           ORL     A,R7
   \   000037   7003         JNZ     $+5
   \   000039   02....       LJMP    ??GenericApp_ProcessEvent_4 & 0xFFFF
   \   00003C   8E82         MOV     DPL,R6
   \   00003E   8F83         MOV     DPH,R7
   \   000040   E0           MOVX    A,@DPTR
   \   000041   24E6         ADD     A,#-0x1a
   \   000043   7003         JNZ     $+5
   \   000045   02....       LJMP    ??GenericApp_ProcessEvent_5 & 0xFFFF
   \   000048   2449         ADD     A,#0x49
   \   00004A   60CC         JZ      ??GenericApp_ProcessEvent_2
   \   00004C   24FE         ADD     A,#-0x2
   \   00004E   70CE         JNZ     ??GenericApp_ProcessEvent_3
   \   000050   EE           MOV     A,R6
   \   000051   240C         ADD     A,#0xc
   \   000053   F582         MOV     DPL,A
   \   000055   EF           MOV     A,R7
   \   000056   3400         ADDC    A,#0x0
   \   000058   F583         MOV     DPH,A
   \   00005A   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_8:
   \   00005D   12....       LCALL   ?US_SWITCH_SPARSE
   \                     `?<Jumptable for GenericApp_ProcessEvent>_0`:
   \   000060   0000         DW        0
   \   000062   0200         DW        2
   \   000064   0680         DW        32774
   \   000066   ....         DW        ??GenericApp_ProcessEvent_6
   \   000068   2080         DW        32800
   \   00006A   ....         DW        ??GenericApp_ProcessEvent_7
   \   00006C   ....         DW        ??GenericApp_ProcessEvent_3
   \                     ??GenericApp_ProcessEvent_6:
   \   00006E                ; Setup parameters for call to function ZDO_ParseEPListRsp
   \   00006E   EE           MOV     A,R6
   \   00006F   FA           MOV     R2,A
   \   000070   EF           MOV     A,R7
   \   000071   FB           MOV     R3,A
   \   000072   12....       LCALL   ??ZDO_ParseEPListRsp?relay
   \   000075   8A..         MOV     ?V0 + 2,R2
   \   000077   8B..         MOV     ?V0 + 3,R3
   \   000079   EA           MOV     A,R2
   \   00007A   45..         ORL     A,?V0 + 3
   \   00007C   60A0         JZ      ??GenericApp_ProcessEvent_3
   \   00007E   8A82         MOV     DPL,R2
   \   000080   8B83         MOV     DPH,R3
   \   000082   E0           MOVX    A,@DPTR
   \   000083   7032         JNZ     ??GenericApp_ProcessEvent_8
   \   000085   A3           INC     DPTR
   \   000086   A3           INC     DPTR
   \   000087   A3           INC     DPTR
   \   000088   E0           MOVX    A,@DPTR
   \   000089   602C         JZ      ??GenericApp_ProcessEvent_8
   \   00008B   90....       MOV     DPTR,#GenericApp_DstAddr + 8
   \   00008E   7402         MOV     A,#0x2
   \   000090   F0           MOVX    @DPTR,A
   \   000091   8A82         MOV     DPL,R2
   \   000093   8B83         MOV     DPH,R3
   \   000095   A3           INC     DPTR
   \   000096   E0           MOVX    A,@DPTR
   \   000097   F8           MOV     R0,A
   \   000098   A3           INC     DPTR
   \   000099   E0           MOVX    A,@DPTR
   \   00009A   F9           MOV     R1,A
   \   00009B   90....       MOV     DPTR,#GenericApp_DstAddr
   \   00009E   E8           MOV     A,R0
   \   00009F   F0           MOVX    @DPTR,A
   \   0000A0   A3           INC     DPTR
   \   0000A1   E9           MOV     A,R1
   \   0000A2   F0           MOVX    @DPTR,A
   \   0000A3   8A82         MOV     DPL,R2
   \   0000A5   8B83         MOV     DPH,R3
   \   0000A7   A3           INC     DPTR
   \   0000A8   A3           INC     DPTR
   \   0000A9   A3           INC     DPTR
   \   0000AA   A3           INC     DPTR
   \   0000AB   E0           MOVX    A,@DPTR
   \   0000AC   90....       MOV     DPTR,#GenericApp_DstAddr + 9
   \   0000AF   F0           MOVX    @DPTR,A
   \   0000B0                ; Setup parameters for call to function HalLedSet
   \   0000B0   7A01         MOV     R2,#0x1
   \   0000B2   7908         MOV     R1,#0x8
   \   0000B4   12....       LCALL   ??HalLedSet?relay
   \                     ??GenericApp_ProcessEvent_8:
   \   0000B7                ; Setup parameters for call to function osal_mem_free
   \   0000B7   AA..         MOV     R2,?V0 + 2
   \   0000B9   AB..         MOV     R3,?V0 + 3
   \   0000BB   12....       LCALL   ??osal_mem_free?relay
   \   0000BE   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
   \                     ??GenericApp_ProcessEvent_7:
   \   0000C1   EE           MOV     A,R6
   \   0000C2   2413         ADD     A,#0x13
   \   0000C4   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_10:
   \   0000C7   700A         JNZ     ??GenericApp_ProcessEvent_9
   \   0000C9                ; Setup parameters for call to function HalLedSet
   \   0000C9   7A01         MOV     R2,#0x1
   \                     ??GenericApp_ProcessEvent_10:
   \   0000CB   7908         MOV     R1,#0x8
   \   0000CD   12....       LCALL   ??HalLedSet?relay
   \   0000D0   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
   \                     ??GenericApp_ProcessEvent_9:
   \   0000D3                ; Setup parameters for call to function HalLedSet
   \   0000D3   7A04         MOV     R2,#0x4
   \   0000D5   80F4         SJMP    ??GenericApp_ProcessEvent_10
   \                     ??GenericApp_ProcessEvent_5:
   \   0000D7   85..82       MOV     DPL,?XSP + 0
   \   0000DA   85..83       MOV     DPH,?XSP + 1
   \   0000DD   7401         MOV     A,#0x1
   \   0000DF   F0           MOVX    @DPTR,A
   \   0000E0   8E82         MOV     DPL,R6
   \   0000E2   8F83         MOV     DPH,R7
   \   0000E4   A3           INC     DPTR
   \   0000E5   A3           INC     DPTR
   \   0000E6   A3           INC     DPTR
   \   0000E7   A3           INC     DPTR
   \   0000E8   12....       LCALL   ?Subroutine4 & 0xFFFF
    344              }
   \                     ??CrossCallReturnLabel_9:
   \   0000EB   12....       LCALL   ?US_SWITCH_DENSE
   \                     `?<Jumptable for GenericApp_ProcessEvent>_1`:
   \   0000EE   0200         DW        2
   \   0000F0   01           DB        1
   \   0000F1   ....         DW        ??GenericApp_ProcessEvent_3
   \   0000F3   ....         DW        ??GenericApp_ProcessEvent_11
   \   0000F5   ....         DW        ??GenericApp_ProcessEvent_12
   \                     ??GenericApp_ProcessEvent_12:
   \   0000F7   EE           MOV     A,R6
   \   0000F8   2422         ADD     A,#0x22
   \   0000FA   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_11:
   \   0000FD   6003         JZ      $+5
   \   0000FF   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
   \   000102                ; Setup parameters for call to function zb_SendDataRequest
   \   000102   75..00       MOV     ?V0 + 2,#0x0
   \   000105   78..         MOV     R0,#?V0 + 2
   \   000107   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00010A   75..10       MOV     ?V0 + 2,#0x10
   \   00010D   78..         MOV     R0,#?V0 + 2
   \   00010F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000112   75..00       MOV     ?V0 + 2,#0x0
   \   000115   78..         MOV     R0,#?V0 + 2
   \   000117   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00011A   7403         MOV     A,#0x3
   \   00011C   12....       LCALL   ?XSTACK_DISP0_8
   \   00011F   8582..       MOV     ?V0 + 2,DPL
   \   000122   8583..       MOV     ?V0 + 3,DPH
   \   000125   78..         MOV     R0,#?V0 + 2
   \   000127   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00012A   7901         MOV     R1,#0x1
   \   00012C   7C03         MOV     R4,#0x3
   \   00012E   7D00         MOV     R5,#0x0
   \   000130   8E82         MOV     DPL,R6
   \   000132   8F83         MOV     DPH,R7
   \   000134   A3           INC     DPTR
   \   000135   A3           INC     DPTR
   \   000136   A3           INC     DPTR
   \   000137   A3           INC     DPTR
   \   000138   A3           INC     DPTR
   \   000139   A3           INC     DPTR
   \   00013A   E0           MOVX    A,@DPTR
   \   00013B   FA           MOV     R2,A
   \   00013C   A3           INC     DPTR
   \   00013D   E0           MOVX    A,@DPTR
   \   00013E   FB           MOV     R3,A
   \   00013F   12....       LCALL   ??zb_SendDataRequest?relay
   \   000142   7405         MOV     A,#0x5
   \   000144   12....       LCALL   ?DEALLOC_XSTACK8
   \   000147   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
   \                     ??GenericApp_ProcessEvent_11:
   \   00014A   8E82         MOV     DPL,R6
   \   00014C   8F83         MOV     DPH,R7
   \   00014E   A3           INC     DPTR
   \   00014F   A3           INC     DPTR
   \   000150   A3           INC     DPTR
   \   000151   A3           INC     DPTR
   \   000152   A3           INC     DPTR
   \   000153   A3           INC     DPTR
   \   000154   E0           MOVX    A,@DPTR
   \   000155   F8           MOV     R0,A
   \   000156   A3           INC     DPTR
   \   000157   E0           MOVX    A,@DPTR
   \   000158   F9           MOV     R1,A
   \   000159   90....       MOV     DPTR,#update_addr
   \   00015C   E8           MOV     A,R0
   \   00015D   F0           MOVX    @DPTR,A
   \   00015E   A3           INC     DPTR
   \   00015F   E9           MOV     A,R1
   \   000160   F0           MOVX    @DPTR,A
   \   000161   EE           MOV     A,R6
   \   000162   2418         ADD     A,#0x18
   \   000164   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_14:
   \   000167   90....       MOV     DPTR,#modbus_rssi
   \   00016A   F0           MOVX    @DPTR,A
   \   00016B   90....       MOV     DPTR,#panId_send
   \   00016E   E0           MOVX    A,@DPTR
   \   00016F   6401         XRL     A,#0x1
   \   000171   700B         JNZ     ??GenericApp_ProcessEvent_13
   \   000173   E4           CLR     A
   \   000174   F0           MOVX    @DPTR,A
   \   000175                ; Setup parameters for call to function calcCRC16
   \   000175   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_6:
   \   000178   12....       LCALL   ??calcCRC16?relay
   \   00017B   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
   \                     ??GenericApp_ProcessEvent_13:
   \   00017E                ; Setup parameters for call to function send_str_Uart
   \   00017E   7C00         MOV     R4,#0x0
   \   000180   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_7:
   \   000183   12....       LCALL   ??send_str_Uart?relay
   \   000186   02....       LJMP    ??GenericApp_ProcessEvent_3 & 0xFFFF
    345          
    346              // return unprocessed events
    347              return (events ^ SYS_EVENT_MSG);
   \                     ??GenericApp_ProcessEvent_4:
   \   000189   AA..         MOV     R2,?V0 + 0
   \   00018B   E5..         MOV     A,?V0 + 1
   \   00018D   6480         XRL     A,#0x80
   \   00018F   FB           MOV     R3,A
   \   000190   02....       LJMP    ??GenericApp_ProcessEvent_14 & 0xFFFF
    348            }
    349            
    350          #if defined ( START_ROUTER)
    351            if ( events & ACK_CHECK)
    352            {
    353              uint8 ack_byte = 0;
    354              if( ack_exist == TRUE)
    355              {
    356                zb_SendDataRequest( 0, ACK_CMD_ID, 1, &ack_byte, 
    357                                         0, AF_ACK_REQUEST, 0);
    358              }
    359              else
    360              {
    361                restore_factory_setting();
    362              }
    363              ack_exist = FALSE;
    364              osal_start_timerEx( GenericApp_TaskID, ACK_CHECK, 10000);   // Every minute check ack, if no receive, restart to join a new network
    365              return ( events ^ ACK_CHECK);
    366            }
    367            // send the command to check tstat modbus id
    368            if( events & ASK_MODBUS_ID)
    369            {
    370              uint8 rssi_byte = 0;
    371              // to read register 6 of tstat
    372              if( tstat_id != 0)
    373              {
    374                zb_SendDataRequest( 0xffff, RSSI_REQ_ID, 1, &rssi_byte, 
    375                                         0, AF_ACK_REQUEST, 0);
    376              }
    377              else
    378              {
    379                HalUARTWrite ( 0, ask_modbus_id, 8 );
    380                len_check_flag = 0;
    381              }
    382              // if not received, send again 2 seconds later
    383              osal_start_timerEx( GenericApp_TaskID, ASK_MODBUS_ID, 2000);
    384              return ( events ^ ASK_MODBUS_ID);
    385            }
    386          #endif  // __defined ( START_ROUTER)
    387            
    388            if( events & TX_MSG_EVENT)
   \                     ??GenericApp_ProcessEvent_0:
   \   000193   EA           MOV     A,R2
   \   000194   5404         ANL     A,#0x4
   \   000196   7003         JNZ     $+5
   \   000198   02....       LJMP    ??GenericApp_ProcessEvent_15 & 0xFFFF
    389            {
    390          #if defined START_ROUTER
    391              uint16 coord_addr = 0;
    392              if( TxBuffer.buf[0] == 0xff)        // 用T3000扫描时要回复
    393              {
    394                // check whether a tstat modbus id response
    395                if( (TxBuffer.buf[1] == 0x03) && (TxBuffer.buf[2] == 0x02))
    396                {
    397                  // store the tstat id
    398                  tstat_id = TxBuffer.buf[4];
    399                }
    400                // When the first byte is 0xff, it's a scan command of T3000 software to scan all the nodes.
    401                zb_SendDataRequest( coord_addr, GENERICAPP_CLUSTERID, TxBuffer.size, TxBuffer.buf, 
    402                                         0, AF_ACK_REQUEST, 0);
    403                TxBuffer.size = 0;
    404              }
    405              else if( (TxBuffer.buf[1] == 0x23) && (TxBuffer.buf[2] == 0x23))
    406              {
    407                send_char_Uart(0x23, 0);
    408                send_char_Uart(numSignalStren, 0);
    409                sendAllSignalStren();
    410                TxBuffer.size = 0;
    411              }
    412              else
    413              {
    414                zb_SendDataRequest( coord_addr, GENERICAPP_CLUSTERID, TxBuffer.size, TxBuffer.buf, 
    415                                         0, AF_ACK_REQUEST, 0);
    416                TxBuffer.size = 0;
    417              }
    418          #else
    419              if( TxBuffer.size > 5)
   \   00019B   90....       MOV     DPTR,#TxBuffer + 512
   \   00019E   C3           CLR     C
   \   00019F   E0           MOVX    A,@DPTR
   \   0001A0   9406         SUBB    A,#0x6
   \   0001A2   A3           INC     DPTR
   \   0001A3   E0           MOVX    A,@DPTR
   \   0001A4   9400         SUBB    A,#0x0
   \   0001A6   5003         JNC     $+5
   \   0001A8   02....       LJMP    ??GenericApp_ProcessEvent_16 & 0xFFFF
    420              {
    421                // the length of scan message is 5
    422               if( (TxBuffer.buf[0] == 0xff) && ( TxBuffer.buf[1] == 0x19))
   \   0001AB   90....       MOV     DPTR,#TxBuffer
   \   0001AE   E0           MOVX    A,@DPTR
   \   0001AF   F4           CPL     A
   \   0001B0   7036         JNZ     ??GenericApp_ProcessEvent_17
   \   0001B2   A3           INC     DPTR
   \   0001B3   E0           MOVX    A,@DPTR
   \   0001B4   6419         XRL     A,#0x19
   \   0001B6   7030         JNZ     ??GenericApp_ProcessEvent_17
    423               {
    424                 // send a broadcast message
    425                 zb_SendDataRequest( 0xFFFF, GENERICAPP_CLUSTERID, 6, TxBuffer.buf, 
    426                                       0, AF_ACK_REQUEST, 0);
   \   0001B8                ; Setup parameters for call to function zb_SendDataRequest
   \   0001B8   75..00       MOV     ?V0 + 2,#0x0
   \   0001BB   78..         MOV     R0,#?V0 + 2
   \   0001BD   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001C0   75..10       MOV     ?V0 + 2,#0x10
   \   0001C3   78..         MOV     R0,#?V0 + 2
   \   0001C5   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001C8   75..00       MOV     ?V0 + 2,#0x0
   \   0001CB   78..         MOV     R0,#?V0 + 2
   \   0001CD   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001D0   75....       MOV     ?V0 + 2,#TxBuffer & 0xff
   \   0001D3   75....       MOV     ?V0 + 3,#(TxBuffer >> 8) & 0xff
   \   0001D6   78..         MOV     R0,#?V0 + 2
   \   0001D8   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001DB   7906         MOV     R1,#0x6
   \                     ??GenericApp_ProcessEvent_18:
   \   0001DD   7C02         MOV     R4,#0x2
   \   0001DF   7D00         MOV     R5,#0x0
   \   0001E1   7AFF         MOV     R2,#-0x1
   \   0001E3   7BFF         MOV     R3,#-0x1
   \   0001E5   02....       LJMP    ??GenericApp_ProcessEvent_19 & 0xFFFF
    427                 TxBuffer.size = 0;
    428               }
    429               else if( (TxBuffer.buf[1] == 3) || ( TxBuffer.buf[1] == 6))
   \                     ??GenericApp_ProcessEvent_17:
   \   0001E8   90....       MOV     DPTR,#TxBuffer + 1
   \   0001EB   E0           MOVX    A,@DPTR
   \   0001EC   6403         XRL     A,#0x3
   \   0001EE   6008         JZ      ??GenericApp_ProcessEvent_20
   \   0001F0   E0           MOVX    A,@DPTR
   \   0001F1   6406         XRL     A,#0x6
   \   0001F3   6003         JZ      $+5
   \   0001F5   02....       LJMP    ??GenericApp_ProcessEvent_21 & 0xFFFF
    430               {
    431                 // the second byte of read command is 0x03, and write command is 0x06
    432                 if( TxBuffer.size > 7)
   \                     ??GenericApp_ProcessEvent_20:
   \   0001F8   90....       MOV     DPTR,#TxBuffer + 512
   \   0001FB   C3           CLR     C
   \   0001FC   E0           MOVX    A,@DPTR
   \   0001FD   9408         SUBB    A,#0x8
   \   0001FF   A3           INC     DPTR
   \   000200   E0           MOVX    A,@DPTR
   \   000201   9400         SUBB    A,#0x0
   \   000203   5003         JNC     $+5
   \   000205   02....       LJMP    ??GenericApp_ProcessEvent_16 & 0xFFFF
    433                 {
    434              // 添加发送PANid
    435              // PanId register need to be writen
    436            #ifdef PANID_DISPLAY
    437                    if( (TxBuffer.buf[0] != 0xff) && ( TxBuffer.buf[1] == 0x03) && (TxBuffer.buf[3] <= 24))
   \   000208   90....       MOV     DPTR,#TxBuffer
   \   00020B   E0           MOVX    A,@DPTR
   \   00020C   F4           CPL     A
   \   00020D   6063         JZ      ??GenericApp_ProcessEvent_22
   \   00020F   A3           INC     DPTR
   \   000210   E0           MOVX    A,@DPTR
   \   000211   6403         XRL     A,#0x3
   \   000213   705D         JNZ     ??GenericApp_ProcessEvent_22
   \   000215   90....       MOV     DPTR,#TxBuffer + 3
   \   000218   E0           MOVX    A,@DPTR
   \   000219   C3           CLR     C
   \   00021A   9419         SUBB    A,#0x19
   \   00021C   5054         JNC     ??GenericApp_ProcessEvent_22
    438                    {
    439                      panId_send_lo = 250;
   \   00021E   90....       MOV     DPTR,#panId_send_lo
   \   000221   74FA         MOV     A,#-0x6
   \   000223   F0           MOVX    @DPTR,A
    440                      panId_send_hi = 250;
   \   000224   90....       MOV     DPTR,#panId_send_hi
   \   000227   F0           MOVX    @DPTR,A
    441                      
    442                      panId_send = TRUE;
   \   000228   90....       MOV     DPTR,#panId_send
   \   00022B   7401         MOV     A,#0x1
   \   00022D   F0           MOVX    @DPTR,A
    443                      for( uint8 i = 0; i < 24; i++)
   \   00022E   7800         MOV     R0,#0x0
    444                      {
    445                        if( i == TxBuffer.buf[3])
   \                     ??GenericApp_ProcessEvent_23:
   \   000230   90....       MOV     DPTR,#TxBuffer + 3
   \   000233   E0           MOVX    A,@DPTR
   \   000234   68           XRL     A,R0
   \   000235   7034         JNZ     ??GenericApp_ProcessEvent_24
    446                        {
    447                          panId_send_hi = 45 - 2*i;
   \   000237   E8           MOV     A,R0
   \   000238   C3           CLR     C
   \   000239   33           RLC     A
   \   00023A   F9           MOV     R1,A
   \   00023B   742D         MOV     A,#0x2d
   \   00023D   C3           CLR     C
   \   00023E   99           SUBB    A,R1
   \   00023F   90....       MOV     DPTR,#panId_send_hi
   \   000242   F0           MOVX    @DPTR,A
    448                          panId_send_lo = 46 - 2*i;
   \   000243   742E         MOV     A,#0x2e
   \   000245   C3           CLR     C
   \   000246   99           SUBB    A,R1
   \   000247   90....       MOV     DPTR,#panId_send_lo
   \   00024A   F0           MOVX    @DPTR,A
    449                          rssi_send_hi = 47 - 2*i;
   \   00024B   742F         MOV     A,#0x2f
   \   00024D   C3           CLR     C
   \   00024E   99           SUBB    A,R1
   \   00024F   90....       MOV     DPTR,#rssi_send_hi
   \   000252   F0           MOVX    @DPTR,A
    450                          rssi_send_lo = 48 - 2*i;
   \   000253   7430         MOV     A,#0x30
   \   000255   C3           CLR     C
   \   000256   99           SUBB    A,R1
   \   000257   90....       MOV     DPTR,#rssi_send_lo
   \   00025A   F0           MOVX    @DPTR,A
    451                          rev_hi = 49 - 2*i;
   \   00025B   7431         MOV     A,#0x31
   \   00025D   C3           CLR     C
   \   00025E   99           SUBB    A,R1
   \   00025F   90....       MOV     DPTR,#rev_hi
   \   000262   F0           MOVX    @DPTR,A
    452                          rev_lo = 50 - 2*i;
   \   000263   7432         MOV     A,#0x32
   \   000265   C3           CLR     C
   \   000266   99           SUBB    A,R1
   \   000267   90....       MOV     DPTR,#rev_lo
   \   00026A   F0           MOVX    @DPTR,A
    453                        }
    454                      }
   \                     ??GenericApp_ProcessEvent_24:
   \   00026B   08           INC     R0
   \   00026C   E8           MOV     A,R0
   \   00026D   C3           CLR     C
   \   00026E   9418         SUBB    A,#0x18
   \   000270   40BE         JC      ??GenericApp_ProcessEvent_23
    455                    }
    456            #endif  // __PANID_DISPLAY
    457            #if defined ( USB_DONGLE)
    458                    if( (TxBuffer.buf[0] == 0xff) || ( TxBuffer.buf[0] == modbus_id))
    459                      modbus_uart_data_process( TxBuffer.buf, TxBuffer.size);
    460                    else
    461            #endif  // __defined ( USB_DONGLE)
    462                    {
    463                       // the length of read command is 8
    464                       // send a broadcast message
    465                       zb_SendDataRequest( 0xFFFF, GENERICAPP_CLUSTERID, TxBuffer.size, TxBuffer.buf, 
    466                                           0, AF_ACK_REQUEST, 0);
   \                     ??GenericApp_ProcessEvent_22:
   \   000272                ; Setup parameters for call to function zb_SendDataRequest
   \   000272   75..00       MOV     ?V0 + 2,#0x0
   \   000275   78..         MOV     R0,#?V0 + 2
   \   000277   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00027A   75..10       MOV     ?V0 + 2,#0x10
   \   00027D   78..         MOV     R0,#?V0 + 2
   \   00027F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000282   75..00       MOV     ?V0 + 2,#0x0
   \   000285   78..         MOV     R0,#?V0 + 2
   \   000287   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00028A   75....       MOV     ?V0 + 2,#TxBuffer & 0xff
   \   00028D   75....       MOV     ?V0 + 3,#(TxBuffer >> 8) & 0xff
   \   000290   78..         MOV     R0,#?V0 + 2
   \   000292   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000295   90....       MOV     DPTR,#TxBuffer + 512
   \   000298   E0           MOVX    A,@DPTR
   \   000299   F9           MOV     R1,A
   \   00029A   02....       LJMP    ??GenericApp_ProcessEvent_18 & 0xFFFF
    467                    }
    468                    TxBuffer.size = 0;
    469                 }
    470               }
    471               else if( (TxBuffer.buf[1] == 0x10) && ( TxBuffer.buf[4] == 0x00) && ( TxBuffer.buf[5] == 0x80))
   \                     ??GenericApp_ProcessEvent_21:
   \   00029D   E0           MOVX    A,@DPTR
   \   00029E   6410         XRL     A,#0x10
   \   0002A0   70D0         JNZ     ??GenericApp_ProcessEvent_22
   \   0002A2   90....       MOV     DPTR,#TxBuffer + 4
   \   0002A5   E0           MOVX    A,@DPTR
   \   0002A6   70CA         JNZ     ??GenericApp_ProcessEvent_22
   \   0002A8   A3           INC     DPTR
   \   0002A9   E0           MOVX    A,@DPTR
   \   0002AA   6480         XRL     A,#0x80
   \   0002AC   70C4         JNZ     ??GenericApp_ProcessEvent_22
    472               {
    473                 if( TxBuffer.size > 5)
    474                 {
    475                   if( TxBuffer.size >= (TxBuffer.buf[5] + 9))
   \   0002AE   90....       MOV     DPTR,#TxBuffer + 512
   \   0002B1   C3           CLR     C
   \   0002B2   E0           MOVX    A,@DPTR
   \   0002B3   9489         SUBB    A,#-0x77
   \   0002B5   A3           INC     DPTR
   \   0002B6   E0           MOVX    A,@DPTR
   \   0002B7   9400         SUBB    A,#0x0
   \   0002B9   4043         JC      ??GenericApp_ProcessEvent_16
    476                   {
    477                     zb_SendDataRequest( update_addr, GENERICAPP_CLUSTERID, TxBuffer.size, TxBuffer.buf, 
    478                                       0, AF_ACK_REQUEST, 0);
   \   0002BB                ; Setup parameters for call to function zb_SendDataRequest
   \   0002BB   75..00       MOV     ?V0 + 2,#0x0
   \   0002BE   78..         MOV     R0,#?V0 + 2
   \   0002C0   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0002C3   75..10       MOV     ?V0 + 2,#0x10
   \   0002C6   78..         MOV     R0,#?V0 + 2
   \   0002C8   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0002CB   75..00       MOV     ?V0 + 2,#0x0
   \   0002CE   78..         MOV     R0,#?V0 + 2
   \   0002D0   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0002D3   75....       MOV     ?V0 + 2,#TxBuffer & 0xff
   \   0002D6   75....       MOV     ?V0 + 3,#(TxBuffer >> 8) & 0xff
   \   0002D9   78..         MOV     R0,#?V0 + 2
   \   0002DB   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0002DE   90....       MOV     DPTR,#TxBuffer + 512
   \   0002E1   E0           MOVX    A,@DPTR
   \   0002E2   F9           MOV     R1,A
   \   0002E3   7C02         MOV     R4,#0x2
   \   0002E5   7D00         MOV     R5,#0x0
   \   0002E7   90....       MOV     DPTR,#update_addr
   \   0002EA   E0           MOVX    A,@DPTR
   \   0002EB   FA           MOV     R2,A
   \   0002EC   A3           INC     DPTR
   \   0002ED   E0           MOVX    A,@DPTR
   \   0002EE   FB           MOV     R3,A
   \                     ??GenericApp_ProcessEvent_19:
   \   0002EF   12....       LCALL   ??zb_SendDataRequest?relay
   \   0002F2   7405         MOV     A,#0x5
   \   0002F4   12....       LCALL   ?DEALLOC_XSTACK8
    479                     TxBuffer.size = 0;
   \   0002F7   90....       MOV     DPTR,#TxBuffer + 512
   \   0002FA   E4           CLR     A
   \   0002FB   F0           MOVX    @DPTR,A
   \   0002FC   A3           INC     DPTR
   \   0002FD   F0           MOVX    @DPTR,A
    480                   }
    481                 }
    482               }
    483               else
    484               {
    485                 zb_SendDataRequest( 0xFFFF, GENERICAPP_CLUSTERID, TxBuffer.size, TxBuffer.buf, 
    486                                       0, AF_ACK_REQUEST, 0);
    487                 TxBuffer.size = 0;
    488               }
    489              }
    490             // every 25 ms to check if there are uart msg
    491             osal_start_timerEx( GenericApp_TaskID, TX_MSG_EVENT, 25);    // LJ 每50毫秒轮询一次检测BUFFER里是否有消息要发出
   \                     ??GenericApp_ProcessEvent_16:
   \   0002FE                ; Setup parameters for call to function osal_start_timerEx
   \   0002FE   7C19         MOV     R4,#0x19
   \   000300   7D00         MOV     R5,#0x0
   \   000302   7A04         MOV     R2,#0x4
   \   000304   7B00         MOV     R3,#0x0
   \   000306   90....       MOV     DPTR,#GenericApp_TaskID
   \   000309   E0           MOVX    A,@DPTR
   \   00030A   F9           MOV     R1,A
   \   00030B   12....       LCALL   ??osal_start_timerEx?relay
    492          #endif  // __defined START_ROUTER
    493             return ( events ^ TX_MSG_EVENT);
   \   00030E   E5..         MOV     A,?V0 + 0
   \   000310   6404         XRL     A,#0x4
   \   000312   FA           MOV     R2,A
   \   000313   AB..         MOV     R3,?V0 + 1
   \   000315   8004         SJMP    ??GenericApp_ProcessEvent_14
    494            }
    495          
    496            // Discard unknown events
    497            return 0;
   \                     ??GenericApp_ProcessEvent_15:
   \   000317   7A00         MOV     R2,#0x0
   \   000319   7B00         MOV     R3,#0x0
   \                     ??GenericApp_ProcessEvent_14:
   \   00031B   7401         MOV     A,#0x1
   \   00031D                REQUIRE ?Subroutine0
   \   00031D                ; // Fall through to label ?Subroutine0
    498          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   12....       LCALL   ?DEALLOC_XSTACK8
   \   000003                REQUIRE ??Subroutine8_0
   \   000003                ; // Fall through to label ??Subroutine8_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine8_0:
   \   000000   7F06         MOV     R7,#0x6
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_18:
   \   000003   F8           MOV     R0,A
   \   000004   A3           INC     DPTR
   \   000005   E0           MOVX    A,@DPTR
   \   000006   F583         MOV     DPH,A
   \   000008   8882         MOV     DPL,R0
   \   00000A   E0           MOVX    A,@DPTR
   \   00000B   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F5..         MOV     ?V0 + 2,A
   \   000003   A3           INC     DPTR
   \   000004   E0           MOVX    A,@DPTR
   \   000005   F5..         MOV     ?V0 + 3,A
   \   000007   78..         MOV     R0,#?V0 + 2
   \   000009   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   EE           MOV     A,R6
   \   000001   2420         ADD     A,#0x20
   \   000003   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_16:
   \   000006   F9           MOV     R1,A
   \   000007   EE           MOV     A,R6
   \   000008   2422         ADD     A,#0x22
   \   00000A   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_17:
   \   00000D   FA           MOV     R2,A
   \   00000E   A3           INC     DPTR
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   FB           MOV     R3,A
   \   000011   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine7:
   \   000000   F582         MOV     DPL,A
   \   000002   EF           MOV     A,R7
   \   000003   3400         ADDC    A,#0x0
   \   000005   F583         MOV     DPH,A
   \   000007   E0           MOVX    A,@DPTR
   \   000008   22           RET
    499          
    500          /*********************************************************************
    501           * Event Generation Functions
    502           */
    503          
    504          /*********************************************************************
    505           * @fn          zb_SendDataRequest
    506           *
    507           * @brief       The function initiates transmission of data
    508           *              to a peer device
    509           * 
    510           * @return      none
    511           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    512          afStatus_t zb_SendDataRequest( uint16 destination, uint16 commandId, uint8 len,
   \                     zb_SendDataRequest:
    513                                    uint8 *pData, uint8 handle, uint8 txOptions, uint8 radius )
    514          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 12
   \   000005   74F4         MOV     A,#-0xc
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8C..         MOV     ?V0 + 2,R4
   \   00000C   8D..         MOV     ?V0 + 3,R5
   \   00000E   E9           MOV     A,R1
   \   00000F   FE           MOV     R6,A
   \   000010   741A         MOV     A,#0x1a
   \   000012   12....       LCALL   ?XSTACK_DISP0_8
   \   000015   E0           MOVX    A,@DPTR
   \   000016   F5..         MOV     ?V0 + 4,A
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   F5..         MOV     ?V0 + 5,A
   \   00001C   741D         MOV     A,#0x1d
   \   00001E   12....       LCALL   ?XSTACK_DISP0_8
   \   000021   E0           MOVX    A,@DPTR
   \   000022   F9           MOV     R1,A
   \   000023   741E         MOV     A,#0x1e
   \   000025   12....       LCALL   ?XSTACK_DISP0_8
   \   000028   E0           MOVX    A,@DPTR
   \   000029   F8           MOV     R0,A
    515            afStatus_t status;
    516            afAddrType_t dstAddr;
    517          
    518            txOptions |= AF_DISCV_ROUTE;
   \   00002A   E9           MOV     A,R1
   \   00002B   D2E5         SETB    0xE0 /* A   */.5
   \   00002D   F9           MOV     R1,A
    519          
    520            // Set the destination address
    521            if (destination == INVALID_NODE_ADDR)
   \   00002E   74FE         MOV     A,#-0x2
   \   000030   6A           XRL     A,R2
   \   000031   7003         JNZ     ??zb_SendDataRequest_0
   \   000033   74FF         MOV     A,#-0x1
   \   000035   6B           XRL     A,R3
   \                     ??zb_SendDataRequest_0:
   \   000036   7008         JNZ     ??zb_SendDataRequest_1
    522            {
    523              // Binding
    524              dstAddr.addrMode = afAddrNotPresent;
   \   000038   7408         MOV     A,#0x8
   \   00003A   12....       LCALL   ?XSTACK_DISP0_8
   \   00003D   E4           CLR     A
   \   00003E   8012         SJMP    ??zb_SendDataRequest_2
    525            }
    526            /*
    527            else if( destination == MAC_SHORT_ADDR_BROADCAST)
    528            {
    529              dstAddr.addr.shortAddr = destination;
    530              dstAddr.addrMode = afAddrBroadcast;
    531            }*/
    532            else
    533            {
    534              // Use short address
    535              dstAddr.addr.shortAddr = destination;
   \                     ??zb_SendDataRequest_1:
   \   000040   85..82       MOV     DPL,?XSP + 0
   \   000043   85..83       MOV     DPH,?XSP + 1
   \   000046   EA           MOV     A,R2
   \   000047   F0           MOVX    @DPTR,A
   \   000048   A3           INC     DPTR
   \   000049   EB           MOV     A,R3
   \   00004A   F0           MOVX    @DPTR,A
    536              dstAddr.addrMode = afAddr16Bit;
   \   00004B   7408         MOV     A,#0x8
   \   00004D   12....       LCALL   ?XSTACK_DISP0_8
   \   000050   7402         MOV     A,#0x2
   \                     ??zb_SendDataRequest_2:
   \   000052   F0           MOVX    @DPTR,A
    537            }
    538          
    539            dstAddr.panId = 0;                                    // Not an inter-pan message.
   \   000053   740A         MOV     A,#0xa
   \   000055   12....       LCALL   ?XSTACK_DISP0_8
   \   000058   E4           CLR     A
   \   000059   F0           MOVX    @DPTR,A
   \   00005A   A3           INC     DPTR
   \   00005B   F0           MOVX    @DPTR,A
    540            dstAddr.endPoint = GenericApp_epDesc.simpleDesc->EndPoint;  // Set the endpoint.
   \   00005C   90....       MOV     DPTR,#GenericApp_epDesc + 3
   \   00005F   E0           MOVX    A,@DPTR
   \   000060   FA           MOV     R2,A
   \   000061   A3           INC     DPTR
   \   000062   E0           MOVX    A,@DPTR
   \   000063   F583         MOV     DPH,A
   \   000065   8A82         MOV     DPL,R2
   \   000067   E0           MOVX    A,@DPTR
   \   000068   C0E0         PUSH    A
   \   00006A   7409         MOV     A,#0x9
   \   00006C   12....       LCALL   ?XSTACK_DISP0_8
   \   00006F   D0E0         POP     A
   \   000071   F0           MOVX    @DPTR,A
    541          
    542            // Send the message
    543            status = AF_DataRequest(&dstAddr, &GenericApp_epDesc, commandId, len,
    544                                    pData, &handle, txOptions, radius);
    545          
    546            return status;
   \   000072                ; Setup parameters for call to function AF_DataRequest
   \   000072   E8           MOV     A,R0
   \   000073   F5..         MOV     ?V0 + 0,A
   \   000075   78..         MOV     R0,#?V0 + 0
   \   000077   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00007A   741D         MOV     A,#0x1d
   \   00007C   12....       LCALL   ?XSTACK_DISP0_8
   \   00007F   8582..       MOV     ?V0 + 0,DPL
   \   000082   8583..       MOV     ?V0 + 1,DPH
   \   000085   78..         MOV     R0,#?V0 + 0
   \   000087   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008A   78..         MOV     R0,#?V0 + 4
   \   00008C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008F   8E..         MOV     ?V0 + 0,R6
   \   000091   75..00       MOV     ?V0 + 1,#0x0
   \   000094   78..         MOV     R0,#?V0 + 0
   \   000096   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000099   78..         MOV     R0,#?V0 + 2
   \   00009B   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00009E   7C..         MOV     R4,#GenericApp_epDesc & 0xff
   \   0000A0   7D..         MOV     R5,#(GenericApp_epDesc >> 8) & 0xff
   \   0000A2   7409         MOV     A,#0x9
   \   0000A4   12....       LCALL   ?XSTACK_DISP0_8
   \   0000A7   AA82         MOV     R2,DPL
   \   0000A9   AB83         MOV     R3,DPH
   \   0000AB   12....       LCALL   ??AF_DataRequest?relay
   \   0000AE   7409         MOV     A,#0x9
   \   0000B0   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000B3   740C         MOV     A,#0xc
   \   0000B5   02....       LJMP    ?Subroutine0 & 0xFFFF
    547          }
    548          /*********************************************************************
    549           * @fn      GenericApp_ProcessZDOMsgs()
    550           *
    551           * @brief   Process response messages
    552           *
    553           * @param   none
    554           *
    555           * @return  none
    556           */
    557          static void GenericApp_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg )
    558          {
    559            switch ( inMsg->clusterID )
    560            {
    561              case End_Device_Bind_rsp:
    562                if ( ZDO_ParseBindRsp( inMsg ) == ZSuccess )
    563                {
    564                  // Light LED
    565                  HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    566                }
    567          #if defined( BLINK_LEDS )
    568                else
    569                {
    570                  // Flash LED to show failure
    571                  HalLedSet ( HAL_LED_4, HAL_LED_MODE_FLASH );
    572                }
    573          #endif
    574                break;
    575          
    576              case Match_Desc_rsp:
    577                {
    578                  ZDO_ActiveEndpointRsp_t *pRsp = ZDO_ParseEPListRsp( inMsg );
    579                  if ( pRsp )
    580                  {
    581                    if ( pRsp->status == ZSuccess && pRsp->cnt )
    582                    {
    583                      GenericApp_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    584                      GenericApp_DstAddr.addr.shortAddr = pRsp->nwkAddr;
    585                      // Take the first endpoint, Can be changed to search through endpoints
    586                      GenericApp_DstAddr.endPoint = pRsp->epList[0];
    587          
    588                      // Light LED
    589                      HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    590                    }
    591                    osal_mem_free( pRsp );
    592                  }
    593                }
    594                break;
    595            }
    596          }
    597          
    598          
    599          
    600          /*********************************************************************
    601           * LOCAL FUNCTIONS
    602           */
    603          
    604          /*********************************************************************
    605           * @fn      GenericApp_MessageMSGCB
    606           *
    607           * @brief   Data message processor callback.  This function processes
    608           *          any incoming data - probably from other devices.  So, based
    609           *          on cluster ID, perform the intended action.
    610           *
    611           * @param   none
    612           *
    613           * @return  none
    614           */
    615          // ************************测试RSSI
    616          #ifdef PANID_DISPLAY

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    617          int8 modbus_rssi;
   \                     modbus_rssi:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    618          // uint8 modbus_correlation;

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    619          unsigned char CRClo;
   \                     CRClo:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    620          unsigned char CRChi;
   \                     CRChi:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment CODE_C, align 1
    621          CONST unsigned char auchCRCHi[256] = {
   \                     auchCRCHi:
   \   000000   00           DB 0
   \   000001   C1           DB 193
   \   000002   81           DB 129
   \   000003   40           DB 64
   \   000004   01           DB 1
   \   000005   C0           DB 192
   \   000006   80           DB 128
   \   000007   41           DB 65
   \   000008   01           DB 1
   \   000009   C0           DB 192
   \   00000A   80           DB 128
   \   00000B   41           DB 65
   \   00000C   00           DB 0
   \   00000D   C1           DB 193
   \   00000E   81           DB 129
   \   00000F   40           DB 64
   \   000010   01           DB 1
   \   000011   C0           DB 192
   \   000012   80           DB 128
   \   000013   41           DB 65
   \   000014   00           DB 0
   \   000015   C1           DB 193
   \   000016   81           DB 129
   \   000017   40           DB 64
   \   000018   00           DB 0
   \   000019   C1           DB 193
   \   00001A   81           DB 129
   \   00001B   40           DB 64
   \   00001C   01           DB 1
   \   00001D   C0           DB 192
   \   00001E   80           DB 128
   \   00001F   41           DB 65
   \   000020   01           DB 1
   \   000021   C0           DB 192
   \   000022   80           DB 128
   \   000023   41           DB 65
   \   000024   00           DB 0
   \   000025   C1           DB 193
   \   000026   81           DB 129
   \   000027   40           DB 64
   \   000028   00           DB 0
   \   000029   C1           DB 193
   \   00002A   81           DB 129
   \   00002B   40           DB 64
   \   00002C   01           DB 1
   \   00002D   C0           DB 192
   \   00002E   80           DB 128
   \   00002F   41           DB 65
   \   000030   00           DB 0
   \   000031   C1           DB 193
   \   000032   81           DB 129
   \   000033   40           DB 64
   \   000034   01           DB 1
   \   000035   C0           DB 192
   \   000036   80           DB 128
   \   000037   41           DB 65
   \   000038   01           DB 1
   \   000039   C0           DB 192
   \   00003A   80           DB 128
   \   00003B   41           DB 65
   \   00003C   00           DB 0
   \   00003D   C1           DB 193
   \   00003E   81           DB 129
   \   00003F   40           DB 64
   \   000040   01           DB 1
   \   000041   C0           DB 192
   \   000042   80           DB 128
   \   000043   41           DB 65
   \   000044   00           DB 0
   \   000045   C1           DB 193
   \   000046   81           DB 129
   \   000047   40           DB 64
   \   000048   00           DB 0
   \   000049   C1           DB 193
   \   00004A   81           DB 129
   \   00004B   40           DB 64
   \   00004C   01           DB 1
   \   00004D   C0           DB 192
   \   00004E   80           DB 128
   \   00004F   41           DB 65
   \   000050   00           DB 0
   \   000051   C1           DB 193
   \   000052   81           DB 129
   \   000053   40           DB 64
   \   000054   01           DB 1
   \   000055   C0           DB 192
   \   000056   80           DB 128
   \   000057   41           DB 65
   \   000058   01           DB 1
   \   000059   C0           DB 192
   \   00005A   80           DB 128
   \   00005B   41           DB 65
   \   00005C   00           DB 0
   \   00005D   C1           DB 193
   \   00005E   81           DB 129
   \   00005F   40           DB 64
   \   000060   00           DB 0
   \   000061   C1           DB 193
   \   000062   81           DB 129
   \   000063   40           DB 64
   \   000064   01           DB 1
   \   000065   C0           DB 192
   \   000066   80           DB 128
   \   000067   41           DB 65
   \   000068   01           DB 1
   \   000069   C0           DB 192
   \   00006A   80           DB 128
   \   00006B   41           DB 65
   \   00006C   00           DB 0
   \   00006D   C1           DB 193
   \   00006E   81           DB 129
   \   00006F   40           DB 64
   \   000070   01           DB 1
   \   000071   C0           DB 192
   \   000072   80           DB 128
   \   000073   41           DB 65
   \   000074   00           DB 0
   \   000075   C1           DB 193
   \   000076   81           DB 129
   \   000077   40           DB 64
   \   000078   00           DB 0
   \   000079   C1           DB 193
   \   00007A   81           DB 129
   \   00007B   40           DB 64
   \   00007C   01           DB 1
   \   00007D   C0           DB 192
   \   00007E   80           DB 128
   \   00007F   41           DB 65
   \   000080   01           DB 1
   \   000081   C0           DB 192
   \   000082   80           DB 128
   \   000083   41           DB 65
   \   000084   00           DB 0
   \   000085   C1           DB 193
   \   000086   81           DB 129
   \   000087   40           DB 64
   \   000088   00           DB 0
   \   000089   C1           DB 193
   \   00008A   81           DB 129
   \   00008B   40           DB 64
   \   00008C   01           DB 1
   \   00008D   C0           DB 192
   \   00008E   80           DB 128
   \   00008F   41           DB 65
   \   000090   00           DB 0
   \   000091   C1           DB 193
   \   000092   81           DB 129
   \   000093   40           DB 64
   \   000094   01           DB 1
   \   000095   C0           DB 192
   \   000096   80           DB 128
   \   000097   41           DB 65
   \   000098   01           DB 1
   \   000099   C0           DB 192
   \   00009A   80           DB 128
   \   00009B   41           DB 65
   \   00009C   00           DB 0
   \   00009D   C1           DB 193
   \   00009E   81           DB 129
   \   00009F   40           DB 64
   \   0000A0   00           DB 0
   \   0000A1   C1           DB 193
   \   0000A2   81           DB 129
   \   0000A3   40           DB 64
   \   0000A4   01           DB 1
   \   0000A5   C0           DB 192
   \   0000A6   80           DB 128
   \   0000A7   41           DB 65
   \   0000A8   01           DB 1
   \   0000A9   C0           DB 192
   \   0000AA   80           DB 128
   \   0000AB   41           DB 65
   \   0000AC   00           DB 0
   \   0000AD   C1           DB 193
   \   0000AE   81           DB 129
   \   0000AF   40           DB 64
   \   0000B0   01           DB 1
   \   0000B1   C0           DB 192
   \   0000B2   80           DB 128
   \   0000B3   41           DB 65
   \   0000B4   00           DB 0
   \   0000B5   C1           DB 193
   \   0000B6   81           DB 129
   \   0000B7   40           DB 64
   \   0000B8   00           DB 0
   \   0000B9   C1           DB 193
   \   0000BA   81           DB 129
   \   0000BB   40           DB 64
   \   0000BC   01           DB 1
   \   0000BD   C0           DB 192
   \   0000BE   80           DB 128
   \   0000BF   41           DB 65
   \   0000C0   00           DB 0
   \   0000C1   C1           DB 193
   \   0000C2   81           DB 129
   \   0000C3   40           DB 64
   \   0000C4   01           DB 1
   \   0000C5   C0           DB 192
   \   0000C6   80           DB 128
   \   0000C7   41           DB 65
   \   0000C8   01           DB 1
   \   0000C9   C0           DB 192
   \   0000CA   80           DB 128
   \   0000CB   41           DB 65
   \   0000CC   00           DB 0
   \   0000CD   C1           DB 193
   \   0000CE   81           DB 129
   \   0000CF   40           DB 64
   \   0000D0   01           DB 1
   \   0000D1   C0           DB 192
   \   0000D2   80           DB 128
   \   0000D3   41           DB 65
   \   0000D4   00           DB 0
   \   0000D5   C1           DB 193
   \   0000D6   81           DB 129
   \   0000D7   40           DB 64
   \   0000D8   00           DB 0
   \   0000D9   C1           DB 193
   \   0000DA   81           DB 129
   \   0000DB   40           DB 64
   \   0000DC   01           DB 1
   \   0000DD   C0           DB 192
   \   0000DE   80           DB 128
   \   0000DF   41           DB 65
   \   0000E0   01           DB 1
   \   0000E1   C0           DB 192
   \   0000E2   80           DB 128
   \   0000E3   41           DB 65
   \   0000E4   00           DB 0
   \   0000E5   C1           DB 193
   \   0000E6   81           DB 129
   \   0000E7   40           DB 64
   \   0000E8   00           DB 0
   \   0000E9   C1           DB 193
   \   0000EA   81           DB 129
   \   0000EB   40           DB 64
   \   0000EC   01           DB 1
   \   0000ED   C0           DB 192
   \   0000EE   80           DB 128
   \   0000EF   41           DB 65
   \   0000F0   00           DB 0
   \   0000F1   C1           DB 193
   \   0000F2   81           DB 129
   \   0000F3   40           DB 64
   \   0000F4   01           DB 1
   \   0000F5   C0           DB 192
   \   0000F6   80           DB 128
   \   0000F7   41           DB 65
   \   0000F8   01           DB 1
   \   0000F9   C0           DB 192
   \   0000FA   80           DB 128
   \   0000FB   41           DB 65
   \   0000FC   00           DB 0
   \   0000FD   C1           DB 193
   \   0000FE   81           DB 129
   \   0000FF   40           DB 64
    622          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    623          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    624          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    625          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    626          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    627          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    628          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    629          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    630          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    631          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    632          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    633          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,//12
    634          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    635          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    636          0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    637          0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40
    638          } ;	
    639          

   \                                 In  segment CODE_C, align 1
    640          CONST unsigned char auchCRCLo[256] = {
   \                     auchCRCLo:
   \   000000   00           DB 0
   \   000001   C0           DB 192
   \   000002   C1           DB 193
   \   000003   01           DB 1
   \   000004   C3           DB 195
   \   000005   03           DB 3
   \   000006   02           DB 2
   \   000007   C2           DB 194
   \   000008   C6           DB 198
   \   000009   06           DB 6
   \   00000A   07           DB 7
   \   00000B   C7           DB 199
   \   00000C   05           DB 5
   \   00000D   C5           DB 197
   \   00000E   C4           DB 196
   \   00000F   04           DB 4
   \   000010   CC           DB 204
   \   000011   0C           DB 12
   \   000012   0D           DB 13
   \   000013   CD           DB 205
   \   000014   0F           DB 15
   \   000015   CF           DB 207
   \   000016   CE           DB 206
   \   000017   0E           DB 14
   \   000018   0A           DB 10
   \   000019   CA           DB 202
   \   00001A   CB           DB 203
   \   00001B   0B           DB 11
   \   00001C   C9           DB 201
   \   00001D   09           DB 9
   \   00001E   08           DB 8
   \   00001F   C8           DB 200
   \   000020   D8           DB 216
   \   000021   18           DB 24
   \   000022   19           DB 25
   \   000023   D9           DB 217
   \   000024   1B           DB 27
   \   000025   DB           DB 219
   \   000026   DA           DB 218
   \   000027   1A           DB 26
   \   000028   1E           DB 30
   \   000029   DE           DB 222
   \   00002A   DF           DB 223
   \   00002B   1F           DB 31
   \   00002C   DD           DB 221
   \   00002D   1D           DB 29
   \   00002E   1C           DB 28
   \   00002F   DC           DB 220
   \   000030   14           DB 20
   \   000031   D4           DB 212
   \   000032   D5           DB 213
   \   000033   15           DB 21
   \   000034   D7           DB 215
   \   000035   17           DB 23
   \   000036   16           DB 22
   \   000037   D6           DB 214
   \   000038   D2           DB 210
   \   000039   12           DB 18
   \   00003A   13           DB 19
   \   00003B   D3           DB 211
   \   00003C   11           DB 17
   \   00003D   D1           DB 209
   \   00003E   D0           DB 208
   \   00003F   10           DB 16
   \   000040   F0           DB 240
   \   000041   30           DB 48
   \   000042   31           DB 49
   \   000043   F1           DB 241
   \   000044   33           DB 51
   \   000045   F3           DB 243
   \   000046   F2           DB 242
   \   000047   32           DB 50
   \   000048   36           DB 54
   \   000049   F6           DB 246
   \   00004A   F7           DB 247
   \   00004B   37           DB 55
   \   00004C   F5           DB 245
   \   00004D   35           DB 53
   \   00004E   34           DB 52
   \   00004F   F4           DB 244
   \   000050   3C           DB 60
   \   000051   FC           DB 252
   \   000052   FD           DB 253
   \   000053   3D           DB 61
   \   000054   FF           DB 255
   \   000055   3F           DB 63
   \   000056   3E           DB 62
   \   000057   FE           DB 254
   \   000058   FA           DB 250
   \   000059   3A           DB 58
   \   00005A   3B           DB 59
   \   00005B   FB           DB 251
   \   00005C   39           DB 57
   \   00005D   F9           DB 249
   \   00005E   F8           DB 248
   \   00005F   38           DB 56
   \   000060   28           DB 40
   \   000061   E8           DB 232
   \   000062   E9           DB 233
   \   000063   29           DB 41
   \   000064   EB           DB 235
   \   000065   2B           DB 43
   \   000066   2A           DB 42
   \   000067   EA           DB 234
   \   000068   EE           DB 238
   \   000069   2E           DB 46
   \   00006A   2F           DB 47
   \   00006B   EF           DB 239
   \   00006C   2D           DB 45
   \   00006D   ED           DB 237
   \   00006E   EC           DB 236
   \   00006F   2C           DB 44
   \   000070   E4           DB 228
   \   000071   24           DB 36
   \   000072   25           DB 37
   \   000073   E5           DB 229
   \   000074   27           DB 39
   \   000075   E7           DB 231
   \   000076   E6           DB 230
   \   000077   26           DB 38
   \   000078   22           DB 34
   \   000079   E2           DB 226
   \   00007A   E3           DB 227
   \   00007B   23           DB 35
   \   00007C   E1           DB 225
   \   00007D   21           DB 33
   \   00007E   20           DB 32
   \   00007F   E0           DB 224
   \   000080   A0           DB 160
   \   000081   60           DB 96
   \   000082   61           DB 97
   \   000083   A1           DB 161
   \   000084   63           DB 99
   \   000085   A3           DB 163
   \   000086   A2           DB 162
   \   000087   62           DB 98
   \   000088   66           DB 102
   \   000089   A6           DB 166
   \   00008A   A7           DB 167
   \   00008B   67           DB 103
   \   00008C   A5           DB 165
   \   00008D   65           DB 101
   \   00008E   64           DB 100
   \   00008F   A4           DB 164
   \   000090   6C           DB 108
   \   000091   AC           DB 172
   \   000092   AD           DB 173
   \   000093   6D           DB 109
   \   000094   AF           DB 175
   \   000095   6F           DB 111
   \   000096   6E           DB 110
   \   000097   AE           DB 174
   \   000098   AA           DB 170
   \   000099   6A           DB 106
   \   00009A   6B           DB 107
   \   00009B   AB           DB 171
   \   00009C   69           DB 105
   \   00009D   A9           DB 169
   \   00009E   A8           DB 168
   \   00009F   68           DB 104
   \   0000A0   78           DB 120
   \   0000A1   B8           DB 184
   \   0000A2   B9           DB 185
   \   0000A3   79           DB 121
   \   0000A4   BB           DB 187
   \   0000A5   7B           DB 123
   \   0000A6   7A           DB 122
   \   0000A7   BA           DB 186
   \   0000A8   BE           DB 190
   \   0000A9   7E           DB 126
   \   0000AA   7F           DB 127
   \   0000AB   BF           DB 191
   \   0000AC   7D           DB 125
   \   0000AD   BD           DB 189
   \   0000AE   BC           DB 188
   \   0000AF   7C           DB 124
   \   0000B0   B4           DB 180
   \   0000B1   74           DB 116
   \   0000B2   75           DB 117
   \   0000B3   B5           DB 181
   \   0000B4   77           DB 119
   \   0000B5   B7           DB 183
   \   0000B6   B6           DB 182
   \   0000B7   76           DB 118
   \   0000B8   72           DB 114
   \   0000B9   B2           DB 178
   \   0000BA   B3           DB 179
   \   0000BB   73           DB 115
   \   0000BC   B1           DB 177
   \   0000BD   71           DB 113
   \   0000BE   70           DB 112
   \   0000BF   B0           DB 176
   \   0000C0   50           DB 80
   \   0000C1   90           DB 144
   \   0000C2   91           DB 145
   \   0000C3   51           DB 81
   \   0000C4   93           DB 147
   \   0000C5   53           DB 83
   \   0000C6   52           DB 82
   \   0000C7   92           DB 146
   \   0000C8   96           DB 150
   \   0000C9   56           DB 86
   \   0000CA   57           DB 87
   \   0000CB   97           DB 151
   \   0000CC   55           DB 85
   \   0000CD   95           DB 149
   \   0000CE   94           DB 148
   \   0000CF   54           DB 84
   \   0000D0   9C           DB 156
   \   0000D1   5C           DB 92
   \   0000D2   5D           DB 93
   \   0000D3   9D           DB 157
   \   0000D4   5F           DB 95
   \   0000D5   9F           DB 159
   \   0000D6   9E           DB 158
   \   0000D7   5E           DB 94
   \   0000D8   5A           DB 90
   \   0000D9   9A           DB 154
   \   0000DA   9B           DB 155
   \   0000DB   5B           DB 91
   \   0000DC   99           DB 153
   \   0000DD   59           DB 89
   \   0000DE   58           DB 88
   \   0000DF   98           DB 152
   \   0000E0   88           DB 136
   \   0000E1   48           DB 72
   \   0000E2   49           DB 73
   \   0000E3   89           DB 137
   \   0000E4   4B           DB 75
   \   0000E5   8B           DB 139
   \   0000E6   8A           DB 138
   \   0000E7   4A           DB 74
   \   0000E8   4E           DB 78
   \   0000E9   8E           DB 142
   \   0000EA   8F           DB 143
   \   0000EB   4F           DB 79
   \   0000EC   8D           DB 141
   \   0000ED   4D           DB 77
   \   0000EE   4C           DB 76
   \   0000EF   8C           DB 140
   \   0000F0   44           DB 68
   \   0000F1   84           DB 132
   \   0000F2   85           DB 133
   \   0000F3   45           DB 69
   \   0000F4   87           DB 135
   \   0000F5   47           DB 71
   \   0000F6   46           DB 70
   \   0000F7   86           DB 134
   \   0000F8   82           DB 130
   \   0000F9   42           DB 66
   \   0000FA   43           DB 67
   \   0000FB   83           DB 131
   \   0000FC   41           DB 65
   \   0000FD   81           DB 129
   \   0000FE   80           DB 128
   \   0000FF   40           DB 64
    641          
    642          0x00, 0xC0, 0xC1, 0x01, 0xC3, 0x03, 0x02, 0xC2, 0xC6, 0x06, 0x07, 0xC7, 0x05, 0xC5, 0xC4, 0x04,
    643          0xCC, 0x0C, 0x0D, 0xCD, 0x0F, 0xCF, 0xCE, 0x0E, 0x0A, 0xCA, 0xCB, 0x0B, 0xC9, 0x09, 0x08, 0xC8,
    644          0xD8, 0x18, 0x19, 0xD9, 0x1B, 0xDB, 0xDA, 0x1A, 0x1E, 0xDE, 0xDF, 0x1F, 0xDD, 0x1D, 0x1C, 0xDC,
    645          0x14, 0xD4, 0xD5, 0x15, 0xD7, 0x17, 0x16, 0xD6, 0xD2, 0x12, 0x13, 0xD3, 0x11, 0xD1, 0xD0, 0x10,
    646          0xF0, 0x30, 0x31, 0xF1, 0x33, 0xF3, 0xF2, 0x32, 0x36, 0xF6, 0xF7, 0x37, 0xF5, 0x35, 0x34, 0xF4,
    647          0x3C, 0xFC, 0xFD, 0x3D, 0xFF, 0x3F, 0x3E, 0xFE, 0xFA, 0x3A, 0x3B, 0xFB, 0x39, 0xF9, 0xF8, 0x38,
    648          0x28, 0xE8, 0xE9, 0x29, 0xEB, 0x2B, 0x2A, 0xEA, 0xEE, 0x2E, 0x2F, 0xEF, 0x2D, 0xED, 0xEC, 0x2C,
    649          0xE4, 0x24, 0x25, 0xE5, 0x27, 0xE7, 0xE6, 0x26, 0x22, 0xE2, 0xE3, 0x23, 0xE1, 0x21, 0x20, 0xE0,
    650          0xA0, 0x60, 0x61, 0xA1, 0x63, 0xA3, 0xA2, 0x62, 0x66, 0xA6, 0xA7, 0x67, 0xA5, 0x65, 0x64, 0xA4,
    651          0x6C, 0xAC, 0xAD, 0x6D, 0xAF, 0x6F, 0x6E, 0xAE, 0xAA, 0x6A, 0x6B, 0xAB, 0x69, 0xA9, 0xA8, 0x68,
    652          0x78, 0xB8, 0xB9, 0x79, 0xBB, 0x7B, 0x7A, 0xBA, 0xBE, 0x7E, 0x7F, 0xBF, 0x7D, 0xBD, 0xBC, 0x7C,
    653          0xB4, 0x74, 0x75, 0xB5, 0x77, 0xB7, 0xB6, 0x76, 0x72, 0xB2, 0xB3, 0x73, 0xB1, 0x71, 0x70, 0xB0,//12
    654          0x50, 0x90, 0x91, 0x51, 0x93, 0x53, 0x52, 0x92, 0x96, 0x56, 0x57, 0x97, 0x55, 0x95, 0x94, 0x54,
    655          0x9C, 0x5C, 0x5D, 0x9D, 0x5F, 0x9F, 0x9E, 0x5E, 0x5A, 0x9A, 0x9B, 0x5B, 0x99, 0x59, 0x58, 0x98,
    656          0x88, 0x48, 0x49, 0x89, 0x4B, 0x8B, 0x8A, 0x4A, 0x4E, 0x8E, 0x8F, 0x4F, 0x8D, 0x4D, 0x4C, 0x8C,
    657          0x44, 0x84, 0x85, 0x45, 0x87, 0x47, 0x46, 0x86, 0x82, 0x42, 0x43, 0x83, 0x41, 0x81, 0x80, 0x40
    658          
    659          } ;

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    660          void InitCRC16(void)
   \                     InitCRC16:
    661          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    662            CRClo = 0xFF;
   \   000004   90....       MOV     DPTR,#CRClo
   \   000007   74FF         MOV     A,#-0x1
   \   000009   F0           MOVX    @DPTR,A
    663            CRChi = 0xFF;
   \   00000A   90....       MOV     DPTR,#CRChi
   \   00000D                REQUIRE ?Subroutine1
   \   00000D                ; // Fall through to label ?Subroutine1
    664          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   F0           MOVX    @DPTR,A
   \   000001   D083         POP     DPH
   \   000003   D082         POP     DPL
   \   000005   02....       LJMP    ?BRET
    665          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    666          void CRC16_Tstat(unsigned char ch)
   \                     CRC16_Tstat:
    667          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    668            unsigned char uIndex ;
    669            uIndex = CRChi ^ ch ; // calculate the CRC 
   \   000004   90....       MOV     DPTR,#CRChi
   \   000007   E0           MOVX    A,@DPTR
   \   000008   69           XRL     A,R1
   \   000009   F8           MOV     R0,A
    670            CRChi = CRClo ^ auchCRCHi[uIndex] ;
   \   00000A   8882         MOV     DPL,R0
   \   00000C   AA82         MOV     R2,DPL
   \   00000E   74..         MOV     A,#auchCRCHi & 0xff
   \   000010   2A           ADD     A,R2
   \   000011   F582         MOV     DPL,A
   \   000013   74..         MOV     A,#(auchCRCHi >> 8) & 0xff
   \   000015   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_12:
   \   000018   F8           MOV     R0,A
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   68           XRL     A,R0
   \   00001B   90....       MOV     DPTR,#CRChi
   \   00001E   F0           MOVX    @DPTR,A
    671            CRClo = auchCRCLo[uIndex] ;
   \   00001F   74..         MOV     A,#auchCRCLo & 0xff
   \   000021   2A           ADD     A,R2
   \   000022   F582         MOV     DPL,A
   \   000024   74..         MOV     A,#(auchCRCLo >> 8) & 0xff
   \   000026   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_13:
   \   000029   80..         SJMP    ?Subroutine1
    672          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine6:
   \   000000   3400         ADDC    A,#0x0
   \   000002   F583         MOV     DPH,A
   \   000004   E4           CLR     A
   \   000005   93           MOVC    A,@A+DPTR
   \   000006   90....       MOV     DPTR,#CRClo
   \   000009   22           RET
    673          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    674          void calcCRC16( uint8* data, uint8 len)
   \                     calcCRC16:
    675          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   \   000009   89..         MOV     ?V0 + 3,R1
    676            uint8 *pData = osal_mem_alloc( len);
   \   00000B                ; Setup parameters for call to function osal_mem_alloc
   \   00000B   89..         MOV     ?V0 + 4,R1
   \   00000D   AA..         MOV     R2,?V0 + 4
   \   00000F   7B00         MOV     R3,#0x0
   \   000011   12....       LCALL   ??osal_mem_alloc?relay
   \   000014   8A..         MOV     ?V0 + 4,R2
   \   000016   8B..         MOV     ?V0 + 5,R3
   \   000018   AE..         MOV     R6,?V0 + 4
   \   00001A   AF..         MOV     R7,?V0 + 5
    677            if( pData)
   \   00001C   EE           MOV     A,R6
   \   00001D   4F           ORL     A,R7
   \   00001E   6017         JZ      ??calcCRC16_0
    678              osal_memcpy( pData, data, len);
   \   000020                ; Setup parameters for call to function osal_memcpy
   \   000020   75..00       MOV     ?V0 + 2,#0x0
   \   000023   78..         MOV     R0,#?V0 + 0
   \   000025   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000028   85....       MOV     ?V0 + 0,?V0 + 3
   \   00002B   AC..         MOV     R4,?V0 + 0
   \   00002D   7D00         MOV     R5,#0x0
   \   00002F   12....       LCALL   ??osal_memcpy?relay
   \   000032   7403         MOV     A,#0x3
   \   000034   12....       LCALL   ?DEALLOC_XSTACK8
    679            
    680            pData[panId_send_hi] = HI_UINT16(_NIB.nwkPanId);
   \                     ??calcCRC16_0:
   \   000037   90....       MOV     DPTR,#_NIB + 34
   \   00003A   E0           MOVX    A,@DPTR
   \   00003B   C0E0         PUSH    A
   \   00003D   90....       MOV     DPTR,#panId_send_hi
   \   000040   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_0:
   \   000043   D0E0         POP     A
   \   000045   F0           MOVX    @DPTR,A
    681            pData[panId_send_lo] = LO_UINT16(_NIB.nwkPanId);
   \   000046   90....       MOV     DPTR,#_NIB + 33
   \   000049   E0           MOVX    A,@DPTR
   \   00004A   C0E0         PUSH    A
   \   00004C   90....       MOV     DPTR,#panId_send_lo
   \   00004F   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   000052   D0E0         POP     A
   \   000054   F0           MOVX    @DPTR,A
    682            pData[rssi_send_hi] = 255;
   \   000055   90....       MOV     DPTR,#rssi_send_hi
   \   000058   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   00005B   74FF         MOV     A,#-0x1
   \   00005D   F0           MOVX    @DPTR,A
    683            pData[rssi_send_lo] = modbus_rssi;
   \   00005E   90....       MOV     DPTR,#modbus_rssi
   \   000061   E0           MOVX    A,@DPTR
   \   000062   C0E0         PUSH    A
   \   000064   90....       MOV     DPTR,#rssi_send_lo
   \   000067   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_3:
   \   00006A   D0E0         POP     A
   \   00006C   F0           MOVX    @DPTR,A
    684            pData[rev_hi] = 0;
   \   00006D   90....       MOV     DPTR,#rev_hi
   \   000070   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_4:
   \   000073   E4           CLR     A
   \   000074   F0           MOVX    @DPTR,A
    685            pData[rev_lo] = TEMCO_ZIGBEE_REV;
   \   000075   90....       MOV     DPTR,#rev_lo
   \   000078   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_5:
   \   00007B   7409         MOV     A,#0x9
   \   00007D   F0           MOVX    @DPTR,A
    686            InitCRC16();
   \   00007E   90....       MOV     DPTR,#CRClo
   \   000081   74FF         MOV     A,#-0x1
   \   000083   F0           MOVX    @DPTR,A
   \   000084   90....       MOV     DPTR,#CRChi
   \   000087   F0           MOVX    @DPTR,A
    687            for( uint8 i = 0; i<(len-2); i++)
   \   000088   75..00       MOV     ?V0 + 2,#0x0
   \   00008B   800C         SJMP    ??calcCRC16_1
    688            {
    689              CRC16_Tstat(pData[i]);
   \                     ??calcCRC16_2:
   \   00008D                ; Setup parameters for call to function CRC16_Tstat
   \   00008D   EE           MOV     A,R6
   \   00008E   25..         ADD     A,?V0 + 0
   \   000090   12....       LCALL   ?Subroutine7 & 0xFFFF
    690            }
   \                     ??CrossCallReturnLabel_15:
   \   000093   F9           MOV     R1,A
   \   000094   12....       LCALL   ??CRC16_Tstat?relay
   \   000097   05..         INC     ?V0 + 2
   \                     ??calcCRC16_1:
   \   000099   85....       MOV     ?V0 + 0,?V0 + 2
   \   00009C   85....       MOV     ?V0 + 4,?V0 + 3
   \   00009F   E5..         MOV     A,?V0 + 4
   \   0000A1   24FE         ADD     A,#-0x2
   \   0000A3   F8           MOV     R0,A
   \   0000A4   E4           CLR     A
   \   0000A5   34FF         ADDC    A,#-0x1
   \   0000A7   F9           MOV     R1,A
   \   0000A8   C3           CLR     C
   \   0000A9   E5..         MOV     A,?V0 + 0
   \   0000AB   98           SUBB    A,R0
   \   0000AC   E4           CLR     A
   \   0000AD   99           SUBB    A,R1
   \   0000AE   A2D2         MOV     C,0xD0 /* PSW */.2
   \   0000B0   65D0         XRL     A,PSW
   \   0000B2   33           RLC     A
   \   0000B3   40D8         JC      ??calcCRC16_2
   \   0000B5   85....       MOV     ?V0 + 0,?V0 + 3
   \   0000B8   EE           MOV     A,R6
   \   0000B9   25..         ADD     A,?V0 + 0
   \   0000BB   F8           MOV     R0,A
   \   0000BC   EF           MOV     A,R7
   \   0000BD   3400         ADDC    A,#0x0
   \   0000BF   F9           MOV     R1,A
   \   0000C0   90....       MOV     DPTR,#CRChi
   \   0000C3   E0           MOVX    A,@DPTR
   \   0000C4   C0E0         PUSH    A
   \   0000C6   E8           MOV     A,R0
   \   0000C7   24FE         ADD     A,#-0x2
   \   0000C9   F582         MOV     DPL,A
   \   0000CB   E9           MOV     A,R1
   \   0000CC   34FF         ADDC    A,#-0x1
   \   0000CE   F583         MOV     DPH,A
   \   0000D0   D0E0         POP     A
   \   0000D2   F0           MOVX    @DPTR,A
    691            pData[len-2] = CRChi;
    692            pData[len-1] = CRClo;
   \   0000D3   90....       MOV     DPTR,#CRClo
   \   0000D6   E0           MOVX    A,@DPTR
   \   0000D7   C0E0         PUSH    A
   \   0000D9   E8           MOV     A,R0
   \   0000DA   24FF         ADD     A,#-0x1
   \   0000DC   F582         MOV     DPL,A
   \   0000DE   E9           MOV     A,R1
   \   0000DF   34FF         ADDC    A,#-0x1
   \   0000E1   F583         MOV     DPH,A
   \   0000E3   D0E0         POP     A
   \   0000E5   F0           MOVX    @DPTR,A
    693          
    694            send_str_Uart( pData, len, 0);
   \   0000E6                ; Setup parameters for call to function send_str_Uart
   \   0000E6   7C00         MOV     R4,#0x0
   \   0000E8   A9..         MOV     R1,?V0 + 3
   \   0000EA   EE           MOV     A,R6
   \   0000EB   FA           MOV     R2,A
   \   0000EC   EF           MOV     A,R7
   \   0000ED   FB           MOV     R3,A
   \   0000EE   12....       LCALL   ??send_str_Uart?relay
    695            osal_mem_free( pData);
   \   0000F1                ; Setup parameters for call to function osal_mem_free
   \   0000F1   EE           MOV     A,R6
   \   0000F2   FA           MOV     R2,A
   \   0000F3   EF           MOV     A,R7
   \   0000F4   FB           MOV     R3,A
   \   0000F5   12....       LCALL   ??osal_mem_free?relay
    696          }
   \   0000F8   02....       LJMP    ??Subroutine8_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   EE           MOV     A,R6
   \   000003   28           ADD     A,R0
   \   000004   F582         MOV     DPL,A
   \   000006   EF           MOV     A,R7
   \   000007   3400         ADDC    A,#0x0
   \   000009   F583         MOV     DPH,A
   \   00000B   22           RET

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??GenericApp_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    GenericApp_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??GenericApp_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    GenericApp_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zb_SendDataRequest?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zb_SendDataRequest

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??InitCRC16?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    InitCRC16

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??CRC16_Tstat?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    CRC16_Tstat

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??calcCRC16?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    calcCRC16
    697          #endif
    698          //*********************************************
    699          static void GenericApp_MessageMSGCB( afIncomingMSGPacket_t *pkt )
    700          {
    701          #if defined (START_ROUTER)
    702            signalStrength_t *pInSignal;
    703          //  uint8 change_network_mode[8] = { 0xff, 0x06, 0x00, 0x78, 0x00, 0x01, 0xdd, 0xcd};
    704          #else
    705            uint8 ack_byte = 1;
    706          #endif
    707            switch ( pkt->clusterId )
    708            {
    709              case GENERICAPP_CLUSTERID:
    710          #if defined START_ROUTER
    711              if( (pkt->cmd.Data[0] != 0xff) && (pkt->cmd.Data[1] == 0x03)&& (pkt->cmd.Data[2]!= 0xee))
    712              {
    713                if( tstat_id == pkt->cmd.Data[0])
    714                {
    715                  len_check_flag = 1;
    716                  reg_len = pkt->cmd.Data[5];
    717                }
    718                else
    719                {
    720                  len_check_flag = 0;
    721                }
    722              }
    723              HalUARTWrite ( 0, pkt->cmd.Data, pkt->cmd.DataLength );
    724          #else
    725              update_addr = pkt->srcAddr.addr.shortAddr;
    726                // send the received msg to uart
    727              
    728            #if defined ( USB_DONGLE)
    729                HalUARTWrite ( 0, pkt->cmd.Data, pkt->cmd.DataLength );
    730            #else
    731                // 测试距离用**********************************
    732                modbus_rssi = pkt->rssi;
    733            //   modbus_correlation = pkt->correlation;
    734            
    735            
    736              #ifdef PANID_DISPLAY
    737                    if( panId_send == TRUE)
    738                    {
    739                    //  TxBuffer.buf[panId_send_hi] = HI_UINT16(_NIB.nwkPanId);
    740                    //  TxBuffer.buf[panId_send_lo] = LO_UINT16(_NIB.nwkPanId);
    741                    //  TxBuffer.buf[panId_send_hi] = 
    742                      
    743                      
    744                      panId_send = FALSE;
    745                      
    746                      calcCRC16( pkt->cmd.Data, pkt->cmd.DataLength);
    747                    }
    748                    else
    749              #endif // __PANID_DISPLAY
    750                    send_str_Uart( pkt->cmd.Data, pkt->cmd.DataLength, 0);
    751                
    752                // ********************************************
    753                
    754                
    755            #endif  //__defined ( USB_DONGLE)
    756              
    757          #endif  // __defined START_ROUTER
    758              break;
    759              case ACK_CMD_ID:
    760          #if defined ( START_ROUTER)
    761                if( pkt->cmd.Data[0] == 1)
    762                  ack_exist = TRUE;
    763          #else
    764                if( pkt->cmd.Data[0] == 0)
    765                  zb_SendDataRequest( pkt->srcAddr.addr.shortAddr, ACK_CMD_ID, 1, &ack_byte, 
    766                                         0, AF_ACK_REQUEST, 0);
    767          
    768          #endif  // __defined ( START_ROUTER)
    769                break;
    770              
    771          #if defined ( START_ROUTER)
    772              case RSSI_REQ_ID:
    773                if( pkt->cmd.Data[0] == 0)
    774                {
    775                  zb_SendDataRequest( pkt->srcAddr.addr.shortAddr, RSSI_RSP_ID, 1, &tstat_id, 
    776                                         0, AF_ACK_REQUEST, 0);
    777                }
    778                break;
    779                
    780              case RSSI_RSP_ID:
    781                if( pkt->cmd.Data[0] != 0)
    782                {
    783                  pInSignal = findSignalStrength( pkt->cmd.Data[0]);
    784                  if( pInSignal != NULL)
    785                  {
    786                    pInSignal->rssi = pkt->rssi;
    787                  }
    788                  else
    789                  {
    790                    register_signalStrength( pkt->cmd.Data[0], pkt->rssi);
    791                    numSignalStren++;
    792                  }
    793                }
    794                break;
    795          #endif //  __defined ( START_ROUTER)
    796            }
    797          }
    798          //*********************************************
    799          #if defined (START_ROUTER)
    800          
    801          static Status_t register_signalStrength( uint8 modbus_id, int8 rssi)
    802          {
    803            signalStrength_t *pNewItem;
    804            signalStrength_t *pLoop;
    805            
    806            pNewItem = osal_mem_alloc( sizeof( signalStrength_t));
    807            if( pNewItem == NULL)
    808            {
    809              return (ZMemError);
    810            }
    811            
    812            pNewItem->next = (signalStrength_t *)NULL;
    813            pNewItem->modbus_id = modbus_id;
    814            pNewItem->rssi = rssi;
    815            
    816            if( pSignalStren == NULL)
    817            {
    818              pSignalStren = pNewItem;
    819            }
    820            else
    821            {
    822              pLoop = pSignalStren;
    823              while( pLoop->next != NULL)
    824              {
    825                pLoop = pLoop->next;
    826              }
    827              pLoop->next = pNewItem;
    828            }
    829            
    830            return SUCCESS;
    831          }
    832          //*********************************************
    833          static signalStrength_t *findSignalStrength( uint8 modbus_id)
    834          {
    835            signalStrength_t *pLoop = pSignalStren;
    836            
    837            while( pLoop != NULL)
    838            {
    839              if( modbus_id == pLoop->modbus_id)
    840              {
    841                return (pLoop);
    842              }
    843              pLoop = pLoop->next;
    844            }
    845            
    846            return ( (signalStrength_t*)NULL);
    847          }
    848          //*********************************************
    849          static void sendAllSignalStren( void)
    850          {
    851            signalStrength_t *pLoop = pSignalStren;
    852            while( pLoop != NULL)
    853            {
    854              send_char_Uart( pLoop->modbus_id, 0);
    855              send_char_Uart( pLoop->rssi, 0);
    856              pLoop = pLoop->next;
    857            }
    858          }
    859          #endif
    860          /*********************************************************************
    861           */

   Maximum stack usage in bytes:

     Function                   ISTACK PSTACK XSTACK
     --------                   ------ ------ ------
     CRC16_Tstat                    2      0     14
     GenericApp_Init                0      0      9
       -> MT_UartInit               0      0     18
       -> afRegister                0      0     18
       -> RegisterForKeys           0      0     18
       -> ZDO_RegisterForZDOMsg     0      0     18
       -> ZDO_RegisterForZDOMsg     0      0     18
       -> osal_set_event            0      0     18
     GenericApp_ProcessEvent        0      0     20
       -> osal_msg_receive          0      0     30
       -> osal_msg_deallocate       0      0     30
       -> osal_msg_receive          0      0     30
       -> ZDO_ParseEPListRsp        0      0     30
       -> HalLedSet                 0      0     30
       -> osal_mem_free             0      0     30
       -> HalLedSet                 0      0     30
       -> HalLedSet                 0      0     30
       -> zb_SendDataRequest        0      0     40
       -> calcCRC16                 0      0     30
       -> send_str_Uart             0      0     30
       -> zb_SendDataRequest        0      0     40
       -> zb_SendDataRequest        0      0     40
       -> zb_SendDataRequest        0      0     40
       -> osal_start_timerEx        0      0     30
     InitCRC16                      2      0      0
     calcCRC16                      1      0     32
       -> osal_mem_alloc            0      0     28
       -> osal_memcpy               0      0     34
       -> CRC16_Tstat               0      0     28
       -> send_str_Uart             0      0     28
       -> osal_mem_free             0      0     28
     zb_SendDataRequest             1      0     55
       -> AF_DataRequest            0      0     70


   Segment part sizes:

     Function/Label                  Bytes
     --------------                  -----
     _A_P1                              1
     GenericApp_ClusterList             2
     GenericApp_SimpleDesc             12
     GenericApp_epDesc                  6
     TxBuffer                         514
     panId_send                         1
     panId_send_hi                      1
     panId_send_lo                      1
     rssi_send_hi                       1
     rssi_send_lo                       1
     rev_hi                             1
     rev_lo                             1
     update_addr                        2
     GenericApp_TaskID                  1
     GenericApp_NwkState                1
     GenericApp_TransID                 1
     GenericApp_DstAddr                12
     GenericApp_Init                  121
     GenericApp_ProcessEvent          797
     ?Subroutine0                       3
     ??Subroutine8_0                    5
     ?Subroutine5                      12
     ?Subroutine4                      10
     ?Subroutine3                      18
     ?Subroutine7                       9
     zb_SendDataRequest               184
     modbus_rssi                        1
     CRClo                              1
     CRChi                              1
     auchCRCHi                        256
     auchCRCLo                        256
     InitCRC16                         13
     ?Subroutine1                       8
     CRC16_Tstat                       43
     ?Subroutine6                      10
     calcCRC16                        251
     ?Subroutine2                      12
     ??GenericApp_Init?relay            6
     ??GenericApp_ProcessEvent?relay    6
     ??zb_SendDataRequest?relay         6
     ??InitCRC16?relay                  6
     ??CRC16_Tstat?relay                6
     ??calcCRC16?relay                  6

 
 1 496 bytes in segment BANKED_CODE
    36 bytes in segment BANK_RELAYS
   512 bytes in segment CODE_C
     1 byte  in segment SFR_AN
    14 bytes in segment XDATA_ROM_C
   547 bytes in segment XDATA_Z
 
 2 044 bytes of CODE  memory
    14 bytes of CONST memory
     0 bytes of DATA  memory (+ 1 byte shared)
   547 bytes of XDATA memory

Errors: none
Warnings: none
